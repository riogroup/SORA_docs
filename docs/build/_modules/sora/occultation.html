

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>sora.occultation &mdash; Stellar Occultation Reduction Analysis develop documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Stellar Occultation Reduction Analysis
          

          
          </a>

          
            
            
              <div class="version">
                0.2.dev0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Manual:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../goals_updates.html">Goals and Version updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../curiosities.html">Curiosities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../future_linea.html">The future and the LIneA TNO Portal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input_output.html">Input and Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora_code.html">SORA Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora_code.html#python-hints-tips-and-tools-for-users-sec-python-hints">Python hints, tips and tools (for users) [Sec:Python_hints]</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples/Tutorial_SORAv0.1_ChiSquare.html">ChiSquare Object Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/Tutorial_SORAv0.1_LightCurve.html">LightCurve Object Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/Tutorial_SORAv0.1_Observer.html">Observer Object Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/Tutorial_SORAv0.1_Occultation.html">Occultation Object Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/Tutorial_SORAv0.1_Prediction.html"><em>prediction()</em> and PredictionTable Object Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/Tutorial_SORAv0.1_Star.html">Star Class</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html">Ephem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.lightcurve">Lightcurve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.observer">Observer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.occultation">Occultation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.prediction">Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.star">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#body">Body</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#extra">Extra</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Stellar Occultation Reduction Analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sora.occultation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sora.occultation</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.star</span> <span class="kn">import</span> <span class="n">Star</span>
<span class="kn">from</span> <span class="nn">.ephem</span> <span class="kn">import</span> <span class="n">EphemPlanete</span><span class="p">,</span> <span class="n">EphemJPL</span><span class="p">,</span> <span class="n">EphemKernel</span>
<span class="kn">from</span> <span class="nn">.observer</span> <span class="kn">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">.lightcurve</span> <span class="kn">import</span> <span class="n">LightCurve</span>
<span class="kn">from</span> <span class="nn">.prediction</span> <span class="kn">import</span> <span class="n">occ_params</span><span class="p">,</span> <span class="n">PredictionTable</span>
<span class="kn">from</span> <span class="nn">.extra</span> <span class="kn">import</span> <span class="n">ChiSquare</span>
<span class="kn">from</span> <span class="nn">sora.body</span> <span class="kn">import</span> <span class="n">Body</span>
<span class="kn">from</span> <span class="nn">sora.config.decorators</span> <span class="kn">import</span> <span class="n">deprecated_alias</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">SkyOffsetFrame</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>


<div class="viewcode-block" id="positionv"><a class="viewcode-back" href="../../sora.html#sora.occultation.positionv">[docs]</a><span class="k">def</span> <span class="nf">positionv</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">ephem</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the position and velocity of the occultation shadow relative to the observer.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        star (Star): The coordinate of the star in the same reference frame as the ephemeris.</span>
<span class="sd">           It must be a Star object.</span>
<span class="sd">        ephem (Ephem): The object ephemeris. It must be an Ephemeris object.</span>
<span class="sd">        observer (Observer): The Observer information. It must be an Observer object.</span>
<span class="sd">        time (Time): Reference instant to calculate position and velocity.</span>

<span class="sd">    Return:</span>
<span class="sd">        f, g (float): The orthographic projection of the shadow relative to the observer.</span>
<span class="sd">            f is in the x-axis (East-West direction; East positive)</span>
<span class="sd">            g is in the y-axis (North-South direction; North positive)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Star</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;star must be a Star object&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ephem</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">EphemPlanete</span><span class="p">,</span> <span class="n">EphemJPL</span><span class="p">,</span> <span class="n">EphemKernel</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ephem must be an Ephemeris object&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Observer</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;observer must be an Observer object&#39;</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="n">coord</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">geocentric</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ephem</span><span class="p">)</span> <span class="o">==</span> <span class="n">EphemPlanete</span><span class="p">:</span>
        <span class="n">ephem</span><span class="o">.</span><span class="n">fit_d2_ksi_eta</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ksio1</span><span class="p">,</span> <span class="n">etao1</span> <span class="o">=</span> <span class="n">observer</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="n">coord</span><span class="p">)</span>
    <span class="n">ksie1</span><span class="p">,</span> <span class="n">etae1</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="n">coord</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">ksio1</span><span class="o">-</span><span class="n">ksie1</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">etao1</span><span class="o">-</span><span class="n">etae1</span>

    <span class="n">ksio2</span><span class="p">,</span> <span class="n">etao2</span> <span class="o">=</span> <span class="n">observer</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="n">coord</span><span class="p">)</span>
    <span class="n">ksie2</span><span class="p">,</span> <span class="n">etae2</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="n">coord</span><span class="p">)</span>

    <span class="n">nf</span> <span class="o">=</span> <span class="n">ksio2</span><span class="o">-</span><span class="n">ksie2</span>
    <span class="n">ng</span> <span class="o">=</span> <span class="n">etao2</span><span class="o">-</span><span class="n">etae2</span>

    <span class="n">vf</span> <span class="o">=</span> <span class="p">(</span><span class="n">nf</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="mf">0.1</span>
    <span class="n">vg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ng</span><span class="o">-</span><span class="n">g</span><span class="p">)</span><span class="o">/</span><span class="mf">0.1</span>

    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span></div>


<div class="viewcode-block" id="fit_ellipse"><a class="viewcode-back" href="../../sora.html#sora.occultation.fit_ellipse">[docs]</a><span class="nd">@deprecated_alias</span><span class="p">(</span><span class="n">pos_angle</span><span class="o">=</span><span class="s1">&#39;position_angle&#39;</span><span class="p">,</span> <span class="n">dpos_angle</span><span class="o">=</span><span class="s1">&#39;dposition_angle&#39;</span><span class="p">)</span>  <span class="c1"># remove this line for v1.0</span>
<span class="k">def</span> <span class="nf">fit_ellipse</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">equatorial_radius</span><span class="p">,</span> <span class="n">dequatorial_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center_f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dcenter_f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center_g</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">dcenter_g</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">oblateness</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">doblateness</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">position_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dposition_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">loop</span><span class="o">=</span><span class="mi">10000000</span><span class="p">,</span> <span class="n">number_chi</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dchi_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fits an ellipse to given occultation using given parameters</span>

<span class="sd">    Parameters:</span>
<span class="sd">        required params:</span>
<span class="sd">        Each occultation is added as the first arguments directly.</span>
<span class="sd">            center_f (int,float): The coordinate in f of the ellipse center. Default=0</span>
<span class="sd">            center_g (int,float): The coordinate in g of the ellipse center. Default=0</span>
<span class="sd">            equatorial_radius (int,float): The Equatorial radius (semi-major axis) of the ellipse.</span>
<span class="sd">            oblateness (int,float): The oblateness of the ellipse. Default=0 (circle)</span>
<span class="sd">            position_angle (int,float): The pole position angle of the ellipse in degrees. Default=0</span>
<span class="sd">                Zero is in the North direction (&#39;g-positive&#39;). Positive clockwise.</span>

<span class="sd">        Parameters interval of fitting. Default values are set to zero.</span>
<span class="sd">        Search between (value - dvalue) and (value + dvalue):</span>
<span class="sd">            dcenter_f (int,float): Interval for coordinate f of the ellipse center</span>
<span class="sd">            dcenter_g (int,float): Interval for coordinate g of the ellipse center</span>
<span class="sd">            dequatorial_radius (int,float): Interval for the Equatorial radius (semi-major axis) of the ellipse</span>
<span class="sd">            doblateness (int,float): Interval for the oblateness of the ellipse</span>
<span class="sd">            dposition_angle (int,float): Interval for the pole position angle of the ellipse in degrees</span>

<span class="sd">        loop (int): The number of ellipses to attempt fitting. Default: 10,000,000</span>
<span class="sd">        dchi_min (intt,float): If given, it will only save ellipsis which chi square are</span>
<span class="sd">            smaller than chi_min + dchi_min.</span>
<span class="sd">        number_chi (int): if dchi_min is given, the procedure is repeated until</span>
<span class="sd">            number_chi is reached. Default: 10,000</span>
<span class="sd">        log (bool): If True, it prints information while fitting. Default: False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        chisquare: A ChiSquare object with all parameters.</span>

<span class="sd">    Examples:</span>
<span class="sd">        fit_ellipse(occ1, **kwargs) to fit the ellipse to the chords of occ1 Occultation object</span>
<span class="sd">        fit_ellipse(occ1, occ2, **kwargs) to fit the ellipse to the chords of occ1 and occ2 Occultation objects together</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">occ</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Occultation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Given argument must be an Occultation object.&#39;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">occ</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">pos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pos_obs</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">pos_obs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pos_lc</span> <span class="o">=</span> <span class="n">pos_obs</span><span class="p">[</span><span class="n">lc</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos_lc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_PositionDict</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">][</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
                        <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
                        <span class="n">erro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">erro</span><span class="p">])</span>
                        <span class="n">chord_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_immersion&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">][</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
                        <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
                        <span class="n">erro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">erro</span><span class="p">])</span>
                        <span class="n">chord_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_emersion&#39;</span><span class="p">)</span>

    <span class="n">controle_f0</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">f0_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">g0_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">a_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">obla_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">posang_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">chi2_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f0_chi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">number_chi</span><span class="p">):</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">center_f</span> <span class="o">+</span> <span class="n">dcenter_f</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">g0</span> <span class="o">=</span> <span class="n">center_g</span> <span class="o">+</span> <span class="n">dcenter_g</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">equatorial_radius</span> <span class="o">+</span> <span class="n">dequatorial_radius</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">obla</span> <span class="o">=</span> <span class="n">oblateness</span> <span class="o">+</span> <span class="n">doblateness</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">obla</span><span class="p">[</span><span class="n">obla</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obla</span><span class="p">[</span><span class="n">obla</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">phi_deg</span> <span class="o">=</span> <span class="n">position_angle</span> <span class="o">+</span> <span class="n">dposition_angle</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">controle_f1</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fi</span><span class="p">,</span> <span class="n">gi</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">obla</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_deg</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">)</span>
            <span class="n">dfi</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-</span><span class="n">f0</span>
            <span class="n">dgi</span> <span class="o">=</span> <span class="n">gi</span><span class="o">-</span><span class="n">g0</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dfi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dgi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dgi</span><span class="p">,</span> <span class="n">dfi</span><span class="p">)</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">theta</span><span class="o">+</span><span class="n">phi</span>
            <span class="n">r_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">f_model</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">+</span> <span class="n">r_model</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">g_model</span> <span class="o">=</span> <span class="n">g0</span> <span class="o">+</span> <span class="n">r_model</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">chi2</span> <span class="o">+=</span> <span class="p">((</span><span class="n">fi</span> <span class="o">-</span> <span class="n">f_model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">gi</span> <span class="o">-</span> <span class="n">g_model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">si</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">controle_f2</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dchi_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">chi2</span> <span class="o">&lt;</span> <span class="n">chi2</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">dchi_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chi2</span><span class="p">))</span>
        <span class="n">chi2_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi2_best</span><span class="p">,</span> <span class="n">chi2</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elapsed time: </span><span class="si">{:.3f}</span><span class="s1"> seconds.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">controle_f2</span> <span class="o">-</span> <span class="n">controle_f1</span><span class="p">)</span><span class="o">.</span><span class="n">sec</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chi2</span><span class="p">[</span><span class="n">region</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">chi2_best</span><span class="p">))</span>
        <span class="n">f0_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f0_chi</span><span class="p">,</span> <span class="n">f0</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
        <span class="n">g0_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g0_chi</span><span class="p">,</span> <span class="n">g0</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
        <span class="n">a_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_chi</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
        <span class="n">obla_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obla_chi</span><span class="p">,</span> <span class="n">obla</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>
        <span class="n">posang_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posang_chi</span><span class="p">,</span> <span class="n">phi_deg</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>

    <span class="n">chisquare</span> <span class="o">=</span> <span class="n">ChiSquare</span><span class="p">(</span><span class="n">chi2_best</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">center_f</span><span class="o">=</span><span class="n">f0_chi</span><span class="p">,</span> <span class="n">center_g</span><span class="o">=</span><span class="n">g0_chi</span><span class="p">,</span> <span class="n">equatorial_radius</span><span class="o">=</span><span class="n">a_chi</span><span class="p">,</span>
                          <span class="n">oblateness</span><span class="o">=</span><span class="n">obla_chi</span><span class="p">,</span> <span class="n">position_angle</span><span class="o">=</span><span class="n">posang_chi</span><span class="p">)</span>
    <span class="n">controle_f4</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total elapsed time: </span><span class="si">{:.3f}</span><span class="s1"> seconds.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">controle_f4</span> <span class="o">-</span> <span class="n">controle_f0</span><span class="p">)</span><span class="o">.</span><span class="n">sec</span><span class="p">))</span>

    <span class="n">onesigma</span> <span class="o">=</span> <span class="n">chisquare</span><span class="o">.</span><span class="n">get_nsigma</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">onesigma</span><span class="p">[</span><span class="s1">&#39;equatorial_radius&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">onesigma</span><span class="p">[</span><span class="s1">&#39;center_f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="n">onesigma</span><span class="p">[</span><span class="s1">&#39;center_g&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obla</span> <span class="o">=</span> <span class="n">onesigma</span><span class="p">[</span><span class="s1">&#39;oblateness&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">phi_deg</span> <span class="o">=</span> <span class="n">onesigma</span><span class="p">[</span><span class="s1">&#39;position_angle&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">radial_dispersion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">error_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">fi</span><span class="p">,</span> <span class="n">gi</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">obla</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_deg</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">)</span>
        <span class="n">dfi</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-</span><span class="n">f0</span>
        <span class="n">dgi</span> <span class="o">=</span> <span class="n">gi</span><span class="o">-</span><span class="n">g0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dfi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dgi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dgi</span><span class="p">,</span> <span class="n">dfi</span><span class="p">)</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">theta</span><span class="o">+</span><span class="n">phi</span>
        <span class="n">r_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">f_model</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">+</span> <span class="n">r_model</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">g_model</span> <span class="o">=</span> <span class="n">g0</span> <span class="o">+</span> <span class="n">r_model</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">radial_dispersion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radial_dispersion</span><span class="p">,</span> <span class="n">r</span> <span class="o">-</span> <span class="n">r_model</span><span class="p">)</span>
        <span class="n">error_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_bar</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">occ</span><span class="p">)</span> <span class="o">==</span> <span class="n">Occultation</span><span class="p">:</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">fitted_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">onesigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equatorial_radius&#39;</span><span class="p">,</span> <span class="s1">&#39;center_f&#39;</span><span class="p">,</span> <span class="s1">&#39;center_g&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;oblateness&#39;</span><span class="p">,</span> <span class="s1">&#39;position_angle&#39;</span><span class="p">]}</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">chi2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chord_name&#39;</span><span class="p">:</span> <span class="n">chord_name</span><span class="p">}</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;radial_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radial_dispersion</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;radial_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_bar</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;chi2_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chisquare</span><span class="o">.</span><span class="n">get_nsigma</span><span class="p">()[</span><span class="s1">&#39;chi2_min&#39;</span><span class="p">]</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;nparam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chisquare</span><span class="o">.</span><span class="n">nparam</span>
            <span class="n">occ</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chisquare</span><span class="o">.</span><span class="n">npts</span>
    <span class="k">return</span> <span class="n">chisquare</span></div>


<span class="k">class</span> <span class="nc">_PositionDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is a modified Dictionary object to allow switching on/off of data points.</span>
<span class="sd">        It also avoids user to change data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Redefines how to set a value to a key in the dictionary.</span>
<span class="sd">            It only sets a value if the key starts with &#39;_occ_&#39;. Otherwise, it only allows for the user to provide</span>
<span class="sd">            &#39;on&#39; or &#39;off&#39; which is passed only to change the &#39;on&#39; keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;on&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_occ_&#39;</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value must be &#39;on&#39; or &#39;off&#39; only.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">_PositionDict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value must be &#39;on&#39; or &#39;off&#39; only.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key1</span><span class="p">])</span> <span class="o">==</span> <span class="n">_PositionDict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">key1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Key &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Occultation"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation">[docs]</a><span class="k">class</span> <span class="nc">Occultation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Does the reduction of the occultation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ephem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instantiates the Occultation object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            star (Star, str): The coordinate of the star in the same reference frame as the ephemeris.</span>
<span class="sd">                It must be a Star object or a string with the coordinates of the object to search on</span>
<span class="sd">                Vizier (required).</span>
<span class="sd">            body* (Body, str): Object that will occult the star. It must be a Body object or its</span>
<span class="sd">                name to search in the Small Body Database.</span>
<span class="sd">            ephem* (Ephem): object ephemeris. It must be an Ephemeris object or a list .</span>
<span class="sd">            time (str, Time): Reference time of the occultation.</span>
<span class="sd">                Time does not need to be exact, but needs to be within approximately 50 minutes</span>
<span class="sd">                of the occultation closest approach to calculate occultation parameters (required).</span>

<span class="sd">        * When instantiating with &quot;body&quot; and &quot;ephem&quot;, the user may define the Occultation in 3 ways:</span>
<span class="sd">            - With &quot;body&quot; and &quot;ephem&quot;.</span>
<span class="sd">            - With only &quot;body&quot;. In this case, the &quot;body&quot; parameter must be a Body object and have an</span>
<span class="sd">                ephemeris associated (see Body documentation).</span>
<span class="sd">            - With only &quot;ephem&quot;. In this case, the &quot;ephem&quot; parameter must be one of the Ephem Classes</span>
<span class="sd">                and have a name (see Ephem documentation) to search for the body in the Small Body Database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ephem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;body&quot; and/or &quot;ephem&quot; must be given.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;time&quot; parameter must be given.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">star</span> <span class="o">=</span> <span class="n">Star</span><span class="p">(</span><span class="n">coord</span><span class="o">=</span><span class="n">star</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">Star</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;star&quot; must be a Star object or a string with coordinates of the star&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span> <span class="o">=</span> <span class="n">star</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Body</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;body&quot; must be a string with the name of the object or a Body object&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">Body</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sbdb&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="k">if</span> <span class="n">ephem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span> <span class="o">=</span> <span class="n">ephem</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ephem</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">Body</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ephem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sbdb&#39;</span><span class="p">,</span> <span class="n">ephem</span><span class="o">=</span><span class="n">ephem</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When only &quot;ephem&quot; is given, &quot;ephem&quot; must have a name for search.&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ephem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;An Ephem object must be defined in Body object.&#39;</span><span class="p">)</span>

        <span class="n">tca</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">occ_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="n">ephem</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">ca</span>   <span class="c1"># Closest Approach distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span>   <span class="c1"># Position Angle at CA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span>  <span class="c1"># Shadow velocity at CA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span>  <span class="c1"># object distance at CA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tca</span> <span class="o">=</span> <span class="n">tca</span>   <span class="c1"># Instant of CA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star_diam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">apparent_diameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;error_ra&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="o">.</span><span class="n">error_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;error_dec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="o">.</span><span class="n">error_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">PredictionTable</span><span class="p">(</span>
            <span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="n">tca</span><span class="p">],</span> <span class="n">coord_star</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">geocentric</span><span class="p">(</span><span class="n">tca</span><span class="p">)],</span>
            <span class="n">coord_obj</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">tca</span><span class="p">)],</span> <span class="n">ca</span><span class="o">=</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">pa</span><span class="o">=</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">vel</span><span class="o">=</span><span class="p">[</span><span class="n">vel</span><span class="o">.</span><span class="n">value</span><span class="p">],</span>
            <span class="n">dist</span><span class="o">=</span><span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">mag</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]],</span> <span class="n">source</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">code</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">()</span>

<div class="viewcode-block" id="Occultation.add_observation"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.add_observation">[docs]</a>    <span class="k">def</span> <span class="nf">add_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">lightcurve</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds observations to the Occultation object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            obs (Observer): The Observer object to be added.</span>
<span class="sd">            lightcurve (LightCurve): The LightCurve object to be added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Observer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;obs must be an Observer object&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lightcurve</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LightCurve</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lightcurve must be a LightCurve object&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">lightcurve</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> LightCurve already associated to </span><span class="si">{}</span><span class="s1"> Observer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lightcurve</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obs</span><span class="p">,</span> <span class="n">lightcurve</span><span class="p">))</span>
        <span class="n">lightcurve</span><span class="o">.</span><span class="n">set_vel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel</span><span class="p">))</span>
        <span class="n">lightcurve</span><span class="o">.</span><span class="n">set_dist</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">AU</span><span class="p">))</span>
        <span class="n">lightcurve</span><span class="o">.</span><span class="n">set_star_diam</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_diam</span><span class="o">.</span><span class="n">km</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lightcurve</span><span class="o">.</span><span class="n">calc_magnitude_drop</span><span class="p">(</span><span class="n">mag_star</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">mag</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">],</span> <span class="n">mag_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">apparent_magnitude</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lightcurve</span><span class="o">.</span><span class="n">bottom_flux</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Magnitude drop was not calculated. Using bottom flux as 0.0 instead.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Occultation.remove_observation"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.remove_observation">[docs]</a>    <span class="k">def</span> <span class="nf">remove_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_lc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes an observation from the Occultation object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            key (str): The name given to Observer or LightCurve to remove from the list.</span>
<span class="sd">            keylc (str): In the case where repeated names are present for different observations,</span>
<span class="sd">                keylc must be given for the name of the LightCurve and key will be used for the name of the Observer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">same_key</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">key_lc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">same_key</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">key_lc</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">ko</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">ko</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key_lc</span><span class="p">:</span>
                <span class="n">kl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ko</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ko</span><span class="p">)</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kl</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">same_key</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">ko</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ko</span> <span class="o">==</span> <span class="n">kl</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">rm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rm_list</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rm_list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kl</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ko</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">kl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ko</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Observation could not univocally be identified, &quot;</span>
                                 <span class="s2">&quot;please give parameters for Observer and LightCurve&quot;</span><span class="p">)</span>
            <span class="n">rm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rm_list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ko</span><span class="p">)))</span>
        <span class="n">rm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rm_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rm_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No observer &quot;</span><span class="si">{}</span><span class="s1">&quot; and/or lightcurve &quot;</span><span class="si">{}</span><span class="s1">&quot; was found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_lc</span><span class="p">))</span>
        <span class="nb">list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rm_list</span><span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span></div>

<div class="viewcode-block" id="Occultation.observations"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.observations">[docs]</a>    <span class="k">def</span> <span class="nf">observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print all the observations added to the Occultation object</span>
<span class="sd">            Pair (Observer, LightCurve)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observer= </span><span class="si">{}</span><span class="s1">, LC: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Occultation.fit_ellipse"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.fit_ellipse">[docs]</a>    <span class="k">def</span> <span class="nf">fit_ellipse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fits an ellipse to the chords of this occultation</span>

<span class="sd">        Parameters:</span>
<span class="sd">        Required parameters:</span>
<span class="sd">            Each occultation is added as the first arguments directly.</span>
<span class="sd">            center_f (int,float): The coordinate in f of the ellipse center.</span>
<span class="sd">            center_g (int,float): The coordinate in g of the ellipse center.</span>
<span class="sd">            equatorial_radius (int,float): The Equatorial radius (semi-major axis) of the ellipse.</span>
<span class="sd">            oblateness (int,float): The oblateness of the ellipse.</span>
<span class="sd">            position_angle (int,float): The pole position angle of the ellipse in degrees. Default=0</span>
<span class="sd">                Zero is in the North direction (&#39;g-positive&#39;). Positive clockwise.</span>

<span class="sd">        Parameters interval of fitting. Default values are set to zero.</span>
<span class="sd">            Search between (value - dvalue) and (value + dvalue):</span>
<span class="sd">            dcenter_f (int,float): Interval for coordinate f of the ellipse center</span>
<span class="sd">            dcenter_g (int,float): Interval for coordinate g of the ellipse center</span>
<span class="sd">            dequatorial_radius (int,float): Interval for the Equatorial radius (semi-major axis) of the ellipse</span>
<span class="sd">            doblateness (int,float): Interval for the oblateness of the ellipse</span>
<span class="sd">            dposition_angle (int,float): Interval for the pole position angle of the ellipse in degrees</span>

<span class="sd">            loop (int): The number of ellipses to attempt fitting. Default: 10,000,000</span>
<span class="sd">            dchi_min (int,float): If given, it will only save ellipsis which chi square are</span>
<span class="sd">                smaller than chi_min + dchi_min.</span>
<span class="sd">            number_chi (int): if dchi_min is given, the procedure is repeated until</span>
<span class="sd">                number_chi is reached. Default: 10,000</span>
<span class="sd">            log (bool): If True, it prints information while fitting. Default: False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            chisquare: A ChiSquare object with all parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chisquare</span> <span class="o">=</span> <span class="n">fit_ellipse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chisquare</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates the position and velocity for all chords.</span>
<span class="sd">            Saves it into an _PositionDict object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is no observation defined for this occultation&#39;</span><span class="p">)</span>

        <span class="n">pair</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
            <span class="n">pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">height</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">position</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">position</span><span class="p">[</span><span class="s1">&#39;_occ_&#39;</span><span class="o">+</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
                <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_occ_lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">lon</span>
                <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_occ_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">lat</span>
                <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_occ_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">height</span>
            <span class="n">pos_obs</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">coord2</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">lon</span> <span class="o">!=</span> <span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]:</span>
                <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_occ_lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">lon</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">lat</span> <span class="o">!=</span> <span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]:</span>
                <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_occ_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">lat</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]:</span>
                <span class="n">position</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_occ_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">height</span>
            <span class="n">samecoord</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord</span> <span class="o">==</span> <span class="n">coord2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_obs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pos_obs</span><span class="p">[</span><span class="s1">&#39;_occ_&#39;</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">()</span>
            <span class="n">pos_lc</span> <span class="o">=</span> <span class="n">pos_obs</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;_occ_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;negative&#39;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;immersion&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;emersion&#39;</span><span class="p">):</span>
                <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;_occ_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;immersion&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;immersion&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_lc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;_occ_immersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">obs_im</span> <span class="o">=</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">]</span>
                <span class="n">do_err</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">samecoord</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">obs_im</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">do_err</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">f1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">vf1</span><span class="p">,</span> <span class="n">vg1</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion</span><span class="p">)</span>
                    <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;_occ_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion</span>
                    <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;_occ_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;_occ_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vf1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">vg1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">do_err</span> <span class="ow">and</span> <span class="s1">&#39;time_err&#39;</span> <span class="ow">in</span> <span class="n">obs_im</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;time_err&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion_err</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fe1</span><span class="p">,</span> <span class="n">ge1</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">immersion_err</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">fe2</span><span class="p">,</span> <span class="n">ge2</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">immersion_err</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;_occ_time_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">immersion_err</span>
                    <span class="n">obs_im</span><span class="p">[</span><span class="s1">&#39;_occ_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">round</span><span class="p">(</span><span class="n">fe1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">ge1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">fe2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">ge2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;emersion&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;emersion&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_lc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;_occ_emersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">obs_em</span> <span class="o">=</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">]</span>
                <span class="n">do_err</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">samecoord</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">obs_em</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">do_err</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">f1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">vf1</span><span class="p">,</span> <span class="n">vg1</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion</span><span class="p">)</span>
                    <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;_occ_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion</span>
                    <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;_occ_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;_occ_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vf1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">vg1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">do_err</span> <span class="ow">and</span> <span class="s1">&#39;time_err&#39;</span> <span class="ow">in</span> <span class="n">obs_em</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;time_err&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion_err</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fe1</span><span class="p">,</span> <span class="n">ge1</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion</span><span class="o">-</span><span class="n">l</span><span class="o">.</span><span class="n">emersion_err</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">fe2</span><span class="p">,</span> <span class="n">ge2</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">emersion_err</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;_occ_time_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">emersion_err</span>
                    <span class="n">obs_em</span><span class="p">[</span><span class="s1">&#39;_occ_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">round</span><span class="p">(</span><span class="n">fe1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">ge1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">fe2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">ge2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;start_obs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_lc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;_occ_start_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">obs_start</span> <span class="o">=</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;start_obs&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">samecoord</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">obs_start</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obs_start</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">initial_time</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">initial_time</span><span class="p">)</span>
                    <span class="n">obs_start</span><span class="p">[</span><span class="s1">&#39;_occ_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">initial_time</span>
                    <span class="n">obs_start</span><span class="p">[</span><span class="s1">&#39;_occ_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="n">obs_start</span><span class="p">[</span><span class="s1">&#39;_occ_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vf</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;end_obs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_lc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;_occ_end_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PositionDict</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">obs_end</span> <span class="o">=</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;end_obs&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">samecoord</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">obs_end</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obs_end</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span> <span class="o">=</span> <span class="n">positionv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
                    <span class="n">obs_end</span><span class="p">[</span><span class="s1">&#39;_occ_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_time</span>
                    <span class="n">obs_end</span><span class="p">[</span><span class="s1">&#39;_occ_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="n">obs_end</span><span class="p">[</span><span class="s1">&#39;_occ_vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vf</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key_lc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">key_lc</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_PositionDict</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_lc</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">position</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">key_lc</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">position</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span>

    <span class="nd">@positions</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If the users tries to set a value to position, it must be &#39;on&#39; or &#39;off&#39;,</span>
<span class="sd">            and it will be assigned to all chords.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value must be &#39;on&#39; or &#39;off&#39; only.&quot;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Occultation.check_velocities"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.check_velocities">[docs]</a>    <span class="k">def</span> <span class="nf">check_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Prints the current velocity used by the LightCurves and its Radial velocity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fitted_params&#39;</span><span class="p">):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_g&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">for</span> <span class="n">ob</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">,</span> <span class="s1">&#39;emersion&#39;</span><span class="p">]]):</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - Velocity used: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lc</span><span class="o">.</span><span class="n">vel</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;immersion&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">]</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">center</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Immersion Radial Velocity: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]),</span> <span class="n">delta</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta</span><span class="p">))))</span>
            <span class="k">if</span> <span class="s1">&#39;emersion&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">em</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">]</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">em</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">center</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Emersion Radial Velocity: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">em</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]),</span> <span class="n">delta</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta</span><span class="p">))))</span></div>

<div class="viewcode-block" id="Occultation.new_astrometric_position"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.new_astrometric_position">[docs]</a>    <span class="k">def</span> <span class="nf">new_astrometric_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates the new astrometric position for the object given fitted parameters</span>

<span class="sd">        Parameters:</span>
<span class="sd">            time (str,Time): Reference time to calculate the position.</span>
<span class="sd">                If not given, it uses the instant of the occultation Closest Approach.</span>
<span class="sd">            offset (list): Offset to apply to the position. If not given, uses the parameters from the fitted ellipse.</span>
<span class="sd">                Must be a list of 3 values being [X, Y, &#39;unit&#39;]</span>
<span class="sd">                    &#39;unit&#39; must be Angular or Distance unit.</span>
<span class="sd">                    - If Distance units for X and Y</span>
<span class="sd">                        Ex: [100, -200, &#39;km&#39;], [0.001, 0.002, &#39;AU&#39;]</span>
<span class="sd">                    - If Angular units fox X [d*a*cos(dec)] and Y [d*dec]</span>
<span class="sd">                        Ex: [30.6, 20, &#39;mas&#39;], or [-15, 2, &#39;arcsec&#39;]</span>

<span class="sd">            error (list): Error bar of the given offset. If not given, it uses the 1-sigma value of the fitted ellipse.</span>
<span class="sd">                Error must be a list of 3 values being [dX, dY, &#39;unit&#39;], similar to offset.</span>
<span class="sd">                It does not need to be in the same unit as offset.</span>
<span class="sd">            log (bool): If true, it Prints text, else it Returns text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tca</span>

        <span class="n">tca_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tca_diff</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The difference between the given time and the closest approach instant is </span><span class="si">{:.1f}</span><span class="s1"> days. &#39;</span>
                          <span class="s1">&#39;This position could not have a physical meaning.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tca_diff</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">off_ra</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">off_dec</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">teste</span> <span class="o">=</span> <span class="n">off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">teste</span> <span class="o">=</span> <span class="n">off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Offset unit must be a distance or angular value.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fitted_params&#39;</span><span class="p">):</span>
            <span class="n">off_ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
            <span class="n">off_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_g&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No offset given or found. Using 0.0 instead.&#39;</span><span class="p">)</span>
            <span class="n">off_ra</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
            <span class="n">off_dec</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">e_off_ra</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">e_off_dec</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">teste</span> <span class="o">=</span> <span class="n">e_off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>
                <span class="n">e_dist</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">teste</span> <span class="o">=</span> <span class="n">e_off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
                    <span class="n">e_dist</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error unit must be a distance or angular value.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fitted_params&#39;</span><span class="p">):</span>
            <span class="n">e_off_ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_f&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
            <span class="n">e_off_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_g&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
            <span class="n">e_dist</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No error given or found. Using 0.0 instead.&#39;</span><span class="p">)</span>
            <span class="n">e_off_ra</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
            <span class="n">e_off_dec</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
            <span class="n">e_dist</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">coord_geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">coord_geo</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>
        <span class="n">coord_frame</span> <span class="o">=</span> <span class="n">SkyOffsetFrame</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">coord_geo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span><span class="p">:</span>
            <span class="n">off_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">off_ra</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
            <span class="n">off_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">off_dec</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e_dist</span><span class="p">:</span>
            <span class="n">e_off_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">e_off_ra</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
            <span class="n">e_off_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">e_off_dec</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">off_ra</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">off_dec</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">coord_frame</span><span class="p">)</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">new_pos</span><span class="o">.</span><span class="n">icrs</span>

        <span class="n">error_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">error_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="p">)</span>
        <span class="n">error_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_star</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">e_off_ra</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">error_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_star</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">e_off_dec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Ephemeris offset (km): X = </span><span class="si">{:.1f}</span><span class="s1"> +/- </span><span class="si">{:.1f}</span><span class="s1">; Y = </span><span class="si">{:.1f}</span><span class="s1"> +/- </span><span class="si">{:.1f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">distance</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">distance</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">e_off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">distance</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">off_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">distance</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">e_off_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Ephemeris offset (mas): da_cos_dec = </span><span class="si">{:.3f}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="s1">; d_dec = </span><span class="si">{:.3f}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">e_off_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">off_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">e_off_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Astrometric object position at time </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;RA = </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="s1"> mas; DEC = </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="s1"> mas&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">new_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">error_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
               <span class="n">new_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">error_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Occultation.plot_chords"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.plot_chords">[docs]</a>    <span class="k">def</span> <span class="nf">plot_chords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_chords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">negative_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">error_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plots the chords of the occultation</span>

<span class="sd">        Parameters:</span>
<span class="sd">            all_chords (bool): if True, it plots all the chords,</span>
<span class="sd">                if False, it sees what was deactivated in self.positions and ignores them</span>
<span class="sd">            positive_color (str): color for the positive chords. Default: blue</span>
<span class="sd">            negative_color (str): color for the negative chords. Default: green</span>
<span class="sd">            error_color (str): color for the error bars of the chords. Default: red</span>
<span class="sd">            ax (maptlotlib.Axes): Axis where to plot chords. Default: Use matplotlib pool.</span>
<span class="sd">            lw (int, float): linewidth of the chords. Default: 2</span>
<span class="sd">            axis_labels (bool): If True it prints the labels of the axis of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">or</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pos_obs</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">pos_obs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pos_lc</span> <span class="o">=</span> <span class="n">pos_obs</span><span class="p">[</span><span class="n">lc</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos_lc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_PositionDict</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;start_obs&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;end_obs&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">negative_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">][</span><span class="s1">&#39;on&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_chords</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">][</span><span class="s1">&#39;on&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_chords</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;immersion&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">pos_lc</span><span class="p">[</span><span class="s1">&#39;emersion&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">positive_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">axis_labels</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;f (km)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;g (km)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Occultation.get_map_sites"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.get_map_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_map_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns Dictionary with sites in the format required by plot_occ_map function</span>

<span class="sd">        Returns:</span>
<span class="sd">            sites (dict): Dictionary with the sites in the format required by plot_occ_map function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
            <span class="n">sites</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]]]</span>
        <span class="k">return</span> <span class="n">sites</span></div>

<div class="viewcode-block" id="Occultation.plot_occ_map"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.plot_occ_map">[docs]</a>    <span class="k">def</span> <span class="nf">plot_occ_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plots the occultation map</span>

<span class="sd">        Parameters:</span>
<span class="sd">            radius: The radius of the shadow. If not given it uses the equatorial radius</span>
<span class="sd">                from the ellipse fit, else it uses the radius obtained from ephem upon instantiating.</span>
<span class="sd">            nameimg (str): Change the name of the image saved.</span>
<span class="sd">            path (str): Path to a directory where to save map.</span>
<span class="sd">            resolution (int): Cartopy feature resolution. &quot;1&quot; means a resolution of &quot;10m&quot;,</span>
<span class="sd">                &quot;2&quot; a resolution of &quot;50m&quot; and &quot;3&quot; a resolution of &quot;100m&quot;. Default = 2</span>
<span class="sd">            states (bool): True to plot the state division of the countries. The states of</span>
<span class="sd">                some countries will only be shown depending on the resolution.</span>
<span class="sd">            zoom (int, float): Zooms in or out of the map.</span>
<span class="sd">            centermap_geo (list): Center the map for a given coordinates in longitude and latitude.</span>
<span class="sd">                It must be a list with two numbers. Default=None.</span>
<span class="sd">            centermap_delta (list): Displace the center of the map given displacement</span>
<span class="sd">                in X and Y, in km. It must be a list with two numbers. Default=None.</span>
<span class="sd">            centerproj (list): Rotates the Earth to show occultation with the center</span>
<span class="sd">                projected at a given longitude and latitude. It must be a list with two numbers</span>
<span class="sd">            labels (bool): Plots text above and below the map with the occultation parameters.</span>
<span class="sd">                Default=True.</span>
<span class="sd">            meridians (int): Plots lines representing the meridians for given interval. Default=30 deg</span>
<span class="sd">            parallels (int): Plots lines representing the parallels for given interval. Default=30 deg</span>
<span class="sd">            sites (dict): Plots site positions in map. It must be a python dictionary where the key is</span>
<span class="sd">                the name of the site, and the value is a list with longitude, latitude, delta_x,</span>
<span class="sd">                delta_y and color. delta_x and delta_y are displacement, in km, from the point</span>
<span class="sd">                of the site in the map and the name. color is the color of the point.</span>
<span class="sd">                If not given, it calculates from observations added to Occultation</span>
<span class="sd">            site_name (bool): If True, it prints the name of the sites given, else it plots only the points</span>
<span class="sd">            countries (dict): Plots the names of countries. It must be a python dictionary where the key</span>
<span class="sd">                is the name of the country and the value is a list with longitude and latitude</span>
<span class="sd">                of the lower left part of the text.</span>
<span class="sd">            offset (list): applies an offset to the ephemeris, calculating new CA and instant of CA.</span>
<span class="sd">                It is a pair of delta_RA*cosDEC and delta_DEC.</span>
<span class="sd">                If not given it uses the center from ellipse fitted.</span>
<span class="sd">            mapstyle (int): Define the color style of the map. 1 is the default black and white scale.</span>
<span class="sd">                &quot;2&quot; is a colored map.</span>
<span class="sd">            error (int,float): Ephemeris error in mas. It plots a dashed line representing radius + error.</span>
<span class="sd">            ercolor (str): Changes the color of the lines of the error bar.</span>
<span class="sd">            ring (int,float): It plots a dashed line representing the location of a ring.</span>
<span class="sd">                It is given in km, from the center.</span>
<span class="sd">            rncolor (str): Changes the color of ring lines.</span>
<span class="sd">            atm (int,float): plots a dashed line representing the location of an atmosphere.</span>
<span class="sd">                It is given in km, from the center.</span>
<span class="sd">            atcolor (str): Changes the color of atm lines.</span>
<span class="sd">            chord_delta (list): list with distances from center to plot chords</span>
<span class="sd">            chord_geo (2d-list): list with pairs of coordinates to plot chords</span>
<span class="sd">            chcolor (str): color of the line of the chords. Default: grey</span>
<span class="sd">            heights (list): plots a circular dashed line showing the locations where the observer</span>
<span class="sd">                would observe the occultation at a given height above the horizons.</span>
<span class="sd">                This must be a list.</span>
<span class="sd">            hcolor (str): Changes the color of the height lines.</span>
<span class="sd">            mapsize (list): The size of figure, in cm. It must be a list with two values.</span>
<span class="sd">                Default = [46.0, 38.0].</span>
<span class="sd">            cpoints (int,float): Interval for the small points marking the center of shadow,</span>
<span class="sd">                in seconds. Default=60.</span>
<span class="sd">            ptcolor (str): Change the color of the center points.</span>
<span class="sd">            alpha (float): The transparency of the night shade, where 0.0 is full transparency</span>
<span class="sd">                and 1.0 is full black. Default = 0.2.</span>
<span class="sd">            fmt (str): The format to save the image. It is parsed directly by matplotlib.pyplot.</span>
<span class="sd">                Default = &#39;png&#39;</span>
<span class="sd">            dpi (int): &quot;Dots per inch&quot;. It defines the quality of the image. Default = 100.</span>
<span class="sd">            lncolor (str): Changes the color of the line that represents the limits of the shadow over Earth.</span>
<span class="sd">            outcolor (str): Changes the color of the lines that represents the limits of the shadow outside Earth</span>
<span class="sd">            nscale (int,float): Arbitrary scale for the size of the name of the site.</span>
<span class="sd">            cscale (int,float): Arbitrary scale for the name of the country.</span>
<span class="sd">            sscale (int,float): Arbitrary scale for the size of point of the site.</span>
<span class="sd">            pscale (int,float): Arbitrary scale for the size of the points that represent the center of the shadow</span>
<span class="sd">            arrow (bool): If true, it plots the arrow with the occultation direction.</span>

<span class="sd">            Comment: Only one of centermap_geo and centermap_delta can be given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;radius&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fitted_params&#39;</span><span class="p">):</span>
            <span class="n">r_equa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;equatorial_radius&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obla</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;oblateness&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos_ang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;position_angle&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span>
            <span class="n">map_pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">[</span><span class="s1">&#39;P/A&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">circle_x</span> <span class="o">=</span> <span class="n">r_equa</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">circle_y</span> <span class="o">=</span> <span class="n">r_equa</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">obla</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">ellipse_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">circle_x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">pos_ang</span><span class="o">-</span><span class="n">map_pa</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span> <span class="o">+</span> <span class="n">circle_y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">pos_ang</span><span class="o">-</span><span class="n">map_pa</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ellipse_y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Projected shadow radius = </span><span class="si">{:.1f}</span><span class="s1"> km&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_map_sites</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fitted_params&#39;</span><span class="p">):</span>
            <span class="n">off_ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
            <span class="n">off_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;center_g&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
            <span class="n">off_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">off_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
            <span class="n">off_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">off_dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">off_ra</span><span class="p">,</span> <span class="n">off_dec</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">plot_occ_map</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Occultation.to_log"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.to_log">[docs]</a>    <span class="k">def</span> <span class="nf">to_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namefile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Saves the occultation log to a file</span>

<span class="sd">        Parameters:</span>
<span class="sd">            namefile (str): Filename to save the log</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">namefile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namefile</span> <span class="o">=</span> <span class="s1">&#39;occ_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">shortname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="o">.</span><span class="n">isot</span><span class="p">[:</span><span class="mi">16</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">namefile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Occultation.to_file"><a class="viewcode-back" href="../../sora.html#sora.occultation.Occultation.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Saves the occultation data to a file</span>

<span class="sd">        Three files are saved containing the positions and velocities for the observations.</span>
<span class="sd">        They are for the positive, negative and error bars positions.</span>

<span class="sd">        The format of the files are: positions in f and g, velocities in f and g, the Julian Date of the observation,</span>
<span class="sd">        light curve name of the corresponding position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ob</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
            <span class="n">l_name</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;immersion&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">err1</span><span class="p">,</span> <span class="n">err2</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                <span class="n">f1</span><span class="p">,</span> <span class="n">g1</span> <span class="o">=</span> <span class="n">err1</span>
                <span class="n">f2</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">err2</span>
                <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_immersion&#39;</span><span class="p">])</span>
                <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;time_err&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_immersion_err-&#39;</span><span class="p">])</span>
                <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f2</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;time_err&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_immersion_err+&#39;</span><span class="p">])</span>

                <span class="n">em</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;emersion&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">err1</span><span class="p">,</span> <span class="n">err2</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                <span class="n">f1</span><span class="p">,</span> <span class="n">g1</span> <span class="o">=</span> <span class="n">err1</span>
                <span class="n">f2</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">err2</span>
                <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span> <span class="o">=</span> <span class="n">em</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="n">em</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_emersion&#39;</span><span class="p">])</span>
                <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="p">(</span><span class="n">em</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">em</span><span class="p">[</span><span class="s1">&#39;time_err&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_emersion_err-&#39;</span><span class="p">])</span>
                <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f2</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="p">(</span><span class="n">em</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">em</span><span class="p">[</span><span class="s1">&#39;time_err&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_emersion_err+&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                <span class="n">ini</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;start_obs&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
                <span class="n">neg</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_start&#39;</span><span class="p">])</span>

                <span class="n">end</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;end_obs&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
                <span class="n">neg</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="n">end</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">jd</span><span class="p">,</span> <span class="n">l_name</span><span class="o">+</span><span class="s1">&#39;_end&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;occ_</span><span class="si">{}</span><span class="s1">_pos.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">shortname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:9.3f}</span><span class="s1"> </span><span class="si">{:9.3f}</span><span class="s1"> </span><span class="si">{:-6.2f}</span><span class="s1"> </span><span class="si">{:-6.2f}</span><span class="s1"> </span><span class="si">{:16.8f}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;occ_</span><span class="si">{}</span><span class="s1">_err.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">shortname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:9.3f}</span><span class="s1"> </span><span class="si">{:9.3f}</span><span class="s1"> </span><span class="si">{:-6.2f}</span><span class="s1"> </span><span class="si">{:-6.2f}</span><span class="s1"> </span><span class="si">{:16.8f}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;occ_</span><span class="si">{}</span><span class="s1">_neg.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">shortname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">neg</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:9.3f}</span><span class="s1"> </span><span class="si">{:9.3f}</span><span class="s1"> </span><span class="si">{:-6.2f}</span><span class="s1"> </span><span class="si">{:-6.2f}</span><span class="s1"> </span><span class="si">{:16.8f}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; String representation of the Occultation class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Stellar occultation of star Gaia-DR2 </span><span class="si">{}</span><span class="s1"> by </span><span class="si">{}</span><span class="s1">.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Geocentric Closest Approach: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Instant of CA: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Position Angle: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Geocentric shadow velocity: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Sun-Geocenter-Target angle:  </span><span class="si">{:.2f}</span><span class="s1"> deg</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Moon-Geocenter-Target angle: </span><span class="si">{:.2f}</span><span class="s1"> deg</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="o">.</span><span class="n">iso</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">[</span><span class="s1">&#39;S-G-T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">[</span><span class="s1">&#39;M-G-T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
               <span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">string</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
            <span class="k">for</span> <span class="n">ob</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observations</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">lc</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">string</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">string</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ob</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">ephem_altaz</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">altaz</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">ephem</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time_mean</span><span class="p">))</span>
                <span class="n">string</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Target altitude: </span><span class="si">{:.1f}</span><span class="s1"> deg</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ephem_altaz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">string</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Target azimuth:  </span><span class="si">{:.1f}</span><span class="s1"> deg</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ephem_altaz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">string</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lc</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span>
                <span class="n">count</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">count</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;No observations reported&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> observations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:^79s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;STAR&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">geocentric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">error_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">error_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">error_star</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Geocentric star coordinate at occultation Epoch (</span><span class="si">{}</span><span class="s1">):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tca</span><span class="o">.</span><span class="n">iso</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;RA=</span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{:.4f}</span><span class="s1">, DEC=</span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{:.4f}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;hms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">error_star</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;dms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="n">error_star</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:^79s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; OBSERVATIONS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">79</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">string</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fitted_params&#39;</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:^79s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;RESULTS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Fitted Ellipse:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.3f}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                              <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">polar_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;equatorial_radius&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;oblateness&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">equivalent_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;equatorial_radius&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">polar_radius</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;polar_radius: </span><span class="si">{:.3f}</span><span class="s1"> km </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polar_radius</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;equivalent_radius: </span><span class="si">{:.3f}</span><span class="s1"> km </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">equivalent_radius</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">H</span><span class="p">):</span>
                <span class="n">H_sun</span> <span class="o">=</span> <span class="o">-</span><span class="mf">26.74</span>
                <span class="n">geometric_albedo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="n">H_sun</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span> <span class="o">*</span> <span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">equivalent_radius</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;geometric albedo (V): </span><span class="si">{:.3f}</span><span class="s1"> (</span><span class="si">{:.1%}</span><span class="s1">) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometric_albedo</span><span class="p">,</span> <span class="n">geometric_albedo</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;geometric albedo (V): not calculated, absolute magnitude (H) is unknown </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Minimum chi-square: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;chi2_min&#39;</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Number of fitted points: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Number of fitted parameters: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;nparam&#39;</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Minimum chi-square per degree of freedom: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;chi2_min&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;nparam&#39;</span><span class="p">]))</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Radial dispersion: </span><span class="si">{:.3f}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="s1"> km</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;radial_dispersion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;radial_dispersion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;Radial error:      </span><span class="si">{:.3f}</span><span class="s1"> +/- </span><span class="si">{:.3f}</span><span class="s1"> km</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;radial_error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2_params</span><span class="p">[</span><span class="s1">&#39;radial_error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_astrometric_position</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, SORA Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>