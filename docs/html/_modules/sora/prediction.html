

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>sora.prediction &mdash; Stellar Occultation Reduction Analysis develop documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Stellar Occultation Reduction Analysis
          

          
          </a>

          
            
            
              <div class="version">
                0.2.dev0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Manual:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../goals_updates.html">Goals and Version updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../curiosities.html">Curiosities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../future_linea.html">The future and the LIneA TNO Portal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input_output.html">Input and Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora_code.html">SORA Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora_code.html#python-hints-tips-and-tools-for-users-sec-python-hints">Python hints, tips and tools (for users) [Sec:Python_hints]</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html">Ephem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.lightcurve">Lightcurve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.observer">Observer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.occultation">Occultation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.prediction">Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.star">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.body">Body</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sora.html#module-sora.extra">Extra</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Stellar Occultation Reduction Analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sora.prediction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sora.prediction</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.star</span> <span class="kn">import</span> <span class="n">Star</span>
<span class="kn">from</span> <span class="nn">.ephem</span> <span class="kn">import</span> <span class="n">EphemKernel</span><span class="p">,</span> <span class="n">EphemJPL</span><span class="p">,</span> <span class="n">EphemPlanete</span><span class="p">,</span> <span class="n">EphemHorizons</span>
<span class="kn">from</span> <span class="nn">sora.body</span> <span class="kn">import</span> <span class="n">Body</span>
<span class="kn">from</span> <span class="nn">sora.config</span> <span class="kn">import</span> <span class="n">input_tests</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span> <span class="k">as</span> <span class="nn">const</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">get_sun</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">get_moon</span><span class="p">,</span> <span class="n">GCRS</span><span class="p">,</span> <span class="n">ITRS</span><span class="p">,</span> <span class="n">SkyOffsetFrame</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Row</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">astroquery.vizier</span> <span class="kn">import</span> <span class="n">Vizier</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">glob</span>


<div class="viewcode-block" id="PredictRow"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictRow">[docs]</a><span class="k">class</span> <span class="nc">PredictRow</span><span class="p">(</span><span class="n">Row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An Astropy Row object modified for Prediction purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PredictRow.plot_occ_map"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictRow.plot_occ_map">[docs]</a>    <span class="k">def</span> <span class="nf">plot_occ_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            radius (int,float): The radius of the shadow. If not given it uses saved value</span>

<span class="sd">            nameimg (str): Change the name of the image saved.</span>
<span class="sd">            path (str): Path to a directory where to save map.</span>
<span class="sd">            resolution (int): Cartopy feature resolution. &quot;1&quot; means a resolution of &quot;10m&quot;,</span>
<span class="sd">                &quot;2&quot; a resolution of &quot;50m&quot; and &quot;3&quot; a resolution of &quot;100m&quot;. Default = 2</span>
<span class="sd">            states (bool): True to plot the state division of the countries. The states of</span>
<span class="sd">                some countries will only be shown depending on the resolution.</span>
<span class="sd">            zoom (int, float): Zooms in or out of the map.</span>
<span class="sd">            centermap_geo (list): Center the map given coordinates in longitude and latitude.</span>
<span class="sd">                It must be a list with two numbers. Default=None.</span>
<span class="sd">            centermap_delta (list): Displace the center of the map given displacement</span>
<span class="sd">                in X and Y, in km. It must be a list with two numbers. Default=None.</span>
<span class="sd">            centerproj (list): Rotates the Earth to show occultation with the center</span>
<span class="sd">                projected at a given longitude and latitude. It must be a list with two numbers</span>
<span class="sd">            labels (bool): Plots text above and below the map with the occultation parameters.</span>
<span class="sd">                Default=True.</span>
<span class="sd">            meridians (int): Plots lines representing the meridians for given interval. Default=30 deg</span>
<span class="sd">            parallels (int): Plots lines representing the parallels for given interval. Default=30 deg</span>
<span class="sd">            sites (dict): Plots site positions in map. It must be a python dictionary where the key is</span>
<span class="sd">                the name of the site, and the value is a list with longitude, latitude, delta_x,</span>
<span class="sd">                delta_y and color. delta_x and delta_y are displacement, in km, from the point</span>
<span class="sd">                of the site in the map and the name. color is the color of the point.</span>
<span class="sd">            site_name (bool): If True, it prints the name of the sites given, else it plots only the points</span>
<span class="sd">            countries (dict): Plots the names of countries. It must be a python dictionary where the key</span>
<span class="sd">                is the name of the country and the value is a list with longitude and latitude</span>
<span class="sd">                of the lower left part of the text.</span>
<span class="sd">            offset (list): applies an offset to the ephemeris, calculating new CA and instant of CA.</span>
<span class="sd">                It is a pair of delta_RA*cosDEC and delta_DEC.</span>
<span class="sd">            mapstyle (int): Define the color style of the map. 1 is the default black and white scale.</span>
<span class="sd">                2 is a colored map.</span>
<span class="sd">            error (int,float): Ephemeris error in mas. It plots a dashed line representing radius + error.</span>
<span class="sd">            ercolor (str): Changes the color of the lines of the error bar.</span>
<span class="sd">            ring (int,float): It plots a dashed line representing the location of a ring.</span>
<span class="sd">                It is given in km, from the center.</span>
<span class="sd">            rncolor (str): Changes the color of ring lines.</span>
<span class="sd">            atm (int,float): plots a dashed line representing the location of an atmosphere.</span>
<span class="sd">                It is given in km, from the center.</span>
<span class="sd">            atcolor (str): Changes the color of atm lines.</span>
<span class="sd">            chord_delta (list): list with distances from center to plot chords</span>
<span class="sd">            chord_geo (2d-list): list with pairs of coordinates to plot chords</span>
<span class="sd">            chcolor (str): color of the line of the chords. Default: grey</span>
<span class="sd">            heights (list): plots a circular dashed line showing the locations where the observer</span>
<span class="sd">                would observe the occultation at a given height above the horizons.</span>
<span class="sd">                This must be a list.</span>
<span class="sd">            hcolor (str): Changes the color of the height lines.</span>
<span class="sd">            mapsize (list): The size of figure, in cm. It must be a list with two values.</span>
<span class="sd">                Default = [46.0, 38.0].</span>
<span class="sd">            cpoints (int,float): Interval for the small points marking the center of shadow,</span>
<span class="sd">                in seconds. Default=60.</span>
<span class="sd">            ptcolor (str): Change the color of the center points.</span>
<span class="sd">            alpha (float): The transparency of the night shade, where 0.0 is full transparency</span>
<span class="sd">                and 1.0 is full black. Default = 0.2.</span>
<span class="sd">            fmt (str): The format to save the image. It is parsed directly by matplotlib.pyplot.</span>
<span class="sd">                Default = &#39;png&#39;</span>
<span class="sd">            dpi (int): &quot;Dots per inch&quot;. It defines the quality of the image. Default = 100.</span>
<span class="sd">            lncolor (str): Changes the color of the line that represents the limits of the shadow over Earth.</span>
<span class="sd">            outcolor (str): Changes the color of the lines that represents the limits of the shadow outside Earth</span>
<span class="sd">            nscale (int,float): Arbitrary scale for the size of the name of the site.</span>
<span class="sd">            cscale (int,float): Arbitrary scale for the name of the country.</span>
<span class="sd">            sscale (int,float): Arbitrary scale for the size of point of the site.</span>
<span class="sd">            pscale (int,float): Arbitrary scale for the size of the points that represent the center of the shadow</span>
<span class="sd">            arrow (bool): If true, it plots the arrow with the occultation direction.</span>

<span class="sd">            Comment: Only one of centermap_geo and centermap_delta can be given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>
        <span class="n">plot_occ_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ICRS Star Coord at Epoch&#39;</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">],</span>
                     <span class="n">ca</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;C/A&#39;</span><span class="p">]),</span> <span class="n">pa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;P/A&#39;</span><span class="p">]),</span> <span class="n">vel</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Vel&#39;</span><span class="p">]),</span> <span class="n">dist</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Dist&#39;</span><span class="p">]),</span>
                     <span class="n">mag</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;G*&#39;</span><span class="p">]),</span> <span class="n">longi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PredictionTable"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable">[docs]</a><span class="k">class</span> <span class="nc">PredictionTable</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An Astropy Table object modified for Prediction purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Row</span> <span class="o">=</span> <span class="n">PredictRow</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
            <span class="n">time</span><span class="o">.</span><span class="n">delta_ut1_utc</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">time</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;iso&#39;</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">isscalar</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">([</span><span class="n">time</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">coord_fmt</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coord_star&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;ICRS Star Coord at Epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">coord_fmt</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coord_geo</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coord_obj&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">coord_geo</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coord_obj&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Geocentric Object Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">coord_geo</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">coord_fmt</span><span class="p">)</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;C/A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ca&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;5.3f&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;P/A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;6.2f&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;-6.2f&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;7.3f&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;AU&#39;</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coord_star&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coord_obj&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ca&#39;</span><span class="p">],</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;mag&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;mag_20&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;User must provide &quot;mag&quot; or &quot;mag_20&quot; parameters&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;mag&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;6.3f&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mag_20&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;Vel&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">20.0</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mag&#39;</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;6.3f&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;mag_20&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mag_20&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;6.3f&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mag_20&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;Vel&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">20.0</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mag&#39;</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;G*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;6.3f&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;long&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;3.0f&#39;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">((</span><span class="n">coord</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;greenwich&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mi">360</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                                        <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;3.0f&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;loct&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;loct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;loct&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;hh:mm&#39;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;loct&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">longi</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;greenwich&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="mi">360</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                <span class="n">ntime</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">longi</span><span class="o">.</span><span class="n">hour</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;loct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ntime</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;hh:mm&#39;</span><span class="p">)</span>
            <span class="n">moon_pos</span> <span class="o">=</span> <span class="n">get_moon</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;M-G-T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">moon_pos</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;3.0f&#39;</span><span class="p">)</span>
            <span class="n">sun_pos</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;S-G-T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">sun_pos</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;3.0f&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;GAIA-DR2 Source ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;GAIA-DR2 Source ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)))</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__itens_by_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets item list for all occultations that matches the given date</span>

<span class="sd">        Parameters:</span>
<span class="sd">            date (str): date to match</span>

<span class="sd">        Returns:</span>
<span class="sd">            item (list): the list of occultations that matches the date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">iso</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">date</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">arr</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The redefinition of __getitem__ allows for selecting prediction based on the ISO date of the event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__itens_by_epoch</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No prediction corresponds to time &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">arr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<div class="viewcode-block" id="PredictionTable.from_praia"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable.from_praia">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_praia</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a PredictionTable Table reading from a PRAIA table</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filename (str): path to the PRAIA table file.</span>
<span class="sd">            name (str): Name of the Object of the prediction.</span>
<span class="sd">            radius (int,float): Object radius, in km. (not required)</span>
<span class="sd">                If not given it&#39;s searched in online database.</span>
<span class="sd">                If not found online, the default is set to zero.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A PredictionTable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.ephem</span> <span class="kn">import</span> <span class="n">read_obj_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">input_tests</span><span class="o">.</span><span class="n">check_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">allowed_kwargs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">41</span><span class="p">,</span>
                <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;hor&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;afh&#39;</span><span class="p">,</span> <span class="s1">&#39;afm&#39;</span><span class="p">,</span> <span class="s1">&#39;afs&#39;</span><span class="p">,</span> <span class="s1">&#39;ded&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;dem&#39;</span><span class="p">,</span> <span class="s1">&#39;des&#39;</span><span class="p">,</span> <span class="s1">&#39;afh2&#39;</span><span class="p">,</span> <span class="s1">&#39;afm2&#39;</span><span class="p">,</span> <span class="s1">&#39;afs2&#39;</span><span class="p">,</span> <span class="s1">&#39;ded2&#39;</span><span class="p">,</span> <span class="s1">&#39;dem2&#39;</span><span class="p">,</span> <span class="s1">&#39;des2&#39;</span><span class="p">,</span> <span class="s1">&#39;ca&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="s1">&#39;mR&#39;</span><span class="p">,</span> <span class="s1">&#39;mK&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;loct&#39;</span><span class="p">,</span> <span class="s1">&#39;ora&#39;</span><span class="p">,</span> <span class="s1">&#39;ode&#39;</span><span class="p">),</span>
                       <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">)},</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not in PRAIA format or does not have any occultation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">max_ca</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="c1"># reading coordinates</span>
        <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;afh&#39;</span><span class="p">],</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;afm&#39;</span><span class="p">,</span> <span class="s1">&#39;afs&#39;</span><span class="p">,</span> <span class="s1">&#39;ded&#39;</span><span class="p">,</span> <span class="s1">&#39;dem&#39;</span><span class="p">,</span> <span class="s1">&#39;des&#39;</span><span class="p">]:</span>
            <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">coord_star</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">))</span>

        <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;afh2&#39;</span><span class="p">],</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;afm2&#39;</span><span class="p">,</span> <span class="s1">&#39;afs2&#39;</span><span class="p">,</span> <span class="s1">&#39;ded2&#39;</span><span class="p">,</span> <span class="s1">&#39;dem2&#39;</span><span class="p">,</span> <span class="s1">&#39;des2&#39;</span><span class="p">]:</span>
            <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">))</span>

        <span class="c1"># reading time</span>
        <span class="n">tim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">],</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">len_iso</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="s1">&#39;hor&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)):</span>
            <span class="n">tim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span> <span class="n">len_iso</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">tim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">defchararray</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;000&#39;</span><span class="p">)</span>

        <span class="c1"># defining parameters</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_obj_data</span><span class="p">()</span>
        <span class="n">radius</span><span class="p">,</span> <span class="n">error_ra</span><span class="p">,</span> <span class="n">error_dec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span> <span class="s1">&#39;max_ca&#39;</span><span class="p">:</span> <span class="n">max_ca</span><span class="p">,</span> <span class="s1">&#39;ephem&#39;</span><span class="p">:</span> <span class="n">lines</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;error_ra&#39;</span><span class="p">:</span> <span class="n">error_ra</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;error_dec&#39;</span><span class="p">:</span> <span class="n">error_dec</span><span class="o">*</span><span class="mi">1000</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">coord_star</span><span class="o">=</span><span class="n">coord_star</span><span class="p">,</span> <span class="n">coord_obj</span><span class="o">=</span><span class="n">coord_obj</span><span class="p">,</span> <span class="n">ca</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;ca&#39;</span><span class="p">],</span> <span class="n">pa</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">],</span>
                   <span class="n">vel</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">mag_20</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;mR&#39;</span><span class="p">],</span> <span class="n">dist</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span>
                   <span class="n">long</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">],</span> <span class="n">loct</span><span class="o">=</span><span class="n">dados</span><span class="p">[</span><span class="s1">&#39;loct&#39;</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span></div>

<div class="viewcode-block" id="PredictionTable.to_praia"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable.to_praia">[docs]</a>    <span class="k">def</span> <span class="nf">to_praia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes PredictionTable to PRAIA format.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filename(str): name of the file to save table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sora.config.variables</span> <span class="kn">import</span> <span class="n">praia_occ_head</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">praia_occ_head</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_ca</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;max_ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                      <span class="n">ephem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ephem&#39;</span><span class="p">,</span> <span class="s1">&#39;ephem&#39;</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">coord_geo</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">mag_20</span><span class="p">,</span> <span class="n">longi</span><span class="p">,</span> <span class="n">loct</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">dmag</span> <span class="o">=</span> <span class="n">mag_20</span><span class="o">-</span><span class="n">mag</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">  </span><span class="si">{}</span><span class="s2">  </span><span class="si">{}</span><span class="s2">   </span><span class="si">{}</span><span class="s2">   </span><span class="si">{:5.3f}</span><span class="s2">  </span><span class="si">{:6.2f}</span><span class="s2"> </span><span class="si">{:-6.2f}</span><span class="s2"> </span><span class="si">{:5.2f}</span><span class="s2"> </span><span class="si">{:4.1f}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{:-4.1f}</span><span class="s2"> </span><span class="si">{:-4.1f}</span><span class="s2"> </span><span class="si">{:-4.1f}</span><span class="s2">   </span><span class="si">{:3.0f}</span><span class="s2">. </span><span class="si">{}</span><span class="s2">       0.0      0.0 ok g2 0    0    0    0    0&quot;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span>
                           <span class="n">coord</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">coord_geo</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
                           <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mag_20</span><span class="p">,</span> <span class="n">dmag</span><span class="p">,</span> <span class="n">dmag</span><span class="p">,</span> <span class="n">dmag</span><span class="p">,</span> <span class="n">longi</span><span class="p">,</span> <span class="n">loct</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="PredictionTable.to_ow"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable.to_ow">[docs]</a>    <span class="k">def</span> <span class="nf">to_ow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ow_des</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes PredictionTable to OccultWatcher feeder update file format.</span>
<span class="sd">            Tables will be saved in two files: &quot;tableOccult_update.txt&quot; and &quot;LOG.dat&quot;</span>

<span class="sd">        Parameters:</span>
<span class="sd">            ow_des (str): Occult Watcher designation for the object.</span>
<span class="sd">            mode (str): &#39;append&#39; to append table to already existing file, default</span>
<span class="sd">                &#39;restart&#39; to overwrite existing file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sora.config.variables</span> <span class="kn">import</span> <span class="n">ow_occ_head</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;append&#39;</span><span class="p">:</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="s1">&#39;restart&#39;</span><span class="p">:</span> <span class="s1">&#39;w&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mode param must be &quot;append&quot; or &quot;restart&quot;.&#39;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tableOccult_update.txt&#39;</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;radius is 0.0, please update the value manually in &quot;tableOccult_update.txt&quot; &#39;</span>
                          <span class="s1">&#39;before submitting the file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;error_ra&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;error_ra&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;error_ra and/or error_dec is 0.0, please update the value manually in &#39;</span>
                          <span class="s1">&#39;&quot;tableOccult_update.txt&quot; before submitting the file&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ow_occ_head</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">ephem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ephem&#39;</span><span class="p">,</span> <span class="s1">&#39;ephem&#39;</span><span class="p">),</span>
                                   <span class="n">max_ca</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;max_ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                   <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">ow_des</span><span class="o">=</span><span class="n">ow_des</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">coord_geo</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">mag_20</span><span class="p">,</span> <span class="n">longi</span><span class="p">,</span> <span class="n">loct</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">dmag</span> <span class="o">=</span> <span class="n">mag_20</span><span class="o">-</span><span class="n">mag</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">  </span><span class="si">{}</span><span class="s1">   </span><span class="si">{}</span><span class="s1">   </span><span class="si">{}</span><span class="s1">   </span><span class="si">{:5.3f}</span><span class="s1">  </span><span class="si">{:6.2f}</span><span class="s1"> </span><span class="si">{:-7.3f}</span><span class="s1"> </span><span class="si">{:7.3f}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{:4.1f}</span><span class="s1"> </span><span class="si">{:-4.1f}</span><span class="s1">   </span><span class="si">{:3.0f}</span><span class="s1">. </span><span class="si">{}</span><span class="s1">  </span><span class="si">{:4.0f}</span><span class="s1">  </span><span class="si">{:4.0f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span>
                           <span class="n">coord</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">coord_geo</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mag_20</span><span class="p">,</span> <span class="n">dmag</span><span class="p">,</span> <span class="n">longi</span><span class="p">,</span> <span class="n">loct</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_ra&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_dec&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">148</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;LOG.dat&#39;</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">isot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; 00:00:00.0&#39;</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="o">*</span><span class="mi">24</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{:5s}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">-</span><span class="si">{:06.3f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isot</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">],</span> <span class="n">ow_des</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">isot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="PredictionTable.plot_occ_map"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable.plot_occ_map">[docs]</a>    <span class="k">def</span> <span class="nf">plot_occ_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            radius (int,float): The radius of the shadow. If not given it uses saved value</span>

<span class="sd">            nameimg (str): Change the name of the image saved.</span>
<span class="sd">            path (str): Path to a directory where to save map.</span>
<span class="sd">            resolution (int): Cartopy feature resolution. &quot;1&quot; means a resolution of &quot;10m&quot;,</span>
<span class="sd">                &quot;2&quot; a resolution of &quot;50m&quot; and &quot;3&quot; a resolution of &quot;100m&quot;. Default = 2</span>
<span class="sd">            states (bool): True to plot the state division of the countries. The states of</span>
<span class="sd">                some countries will only be shown depending on the resolution.</span>
<span class="sd">            zoom (int, float): Zooms in or out of the map.</span>
<span class="sd">            centermap_geo (list): Center the map given coordinates in longitude and latitude.</span>
<span class="sd">                It must be a list with two numbers. Default=None.</span>
<span class="sd">            centermap_delta (list): Displace the center of the map given displacement</span>
<span class="sd">                in X and Y, in km. It must be a list with two numbers. Default=None.</span>
<span class="sd">            centerproj (list): Rotates the Earth to show occultation with the center</span>
<span class="sd">                projected at a given longitude and latitude. It must be a list with two numbers</span>
<span class="sd">            labels (bool): Plots text above and below the map with the occultation parameters.</span>
<span class="sd">                Default=True.</span>
<span class="sd">            meridians (int): Plots lines representing the meridians for given interval. Default=30 deg</span>
<span class="sd">            parallels (int): Plots lines representing the parallels for given interval. Default=30 deg</span>
<span class="sd">            sites (dict): Plots site positions in map. It must be a python dictionary where the key is</span>
<span class="sd">                the name of the site, and the value is a list with longitude, latitude, delta_x,</span>
<span class="sd">                delta_y and color. delta_x and delta_y are displacement, in km, from the point</span>
<span class="sd">                of the site in the map and the name. color is the color of the point.</span>
<span class="sd">            site_name (bool): If True, it prints the name of the sites given, else it plots only the points</span>
<span class="sd">            countries (dict): Plots the names of countries. It must be a python dictionary where the key</span>
<span class="sd">                is the name of the country and the value is a list with longitude and latitude</span>
<span class="sd">                of the lower left part of the text.</span>
<span class="sd">            offset (list): applies an offset to the ephemeris, calculating new CA and instant of CA.</span>
<span class="sd">                It is a pair of delta_RA*cosDEC and delta_DEC.</span>
<span class="sd">            mapstyle (int): Define the color style of the map. 1 is the default black and white scale.</span>
<span class="sd">                2 is a colored map.</span>
<span class="sd">            error (int,float): Ephemeris error in mas. It plots a dashed line representing radius + error.</span>
<span class="sd">            ercolor (str): Changes the color of the lines of the error bar.</span>
<span class="sd">            ring (int,float): plots a dashed line representing the location of a ring.</span>
<span class="sd">                It is given in km, from the center.</span>
<span class="sd">            rncolor (str): Changes the color of ring lines.</span>
<span class="sd">            atm (int,float): plots a dashed line representing the location of an atmosphere.</span>
<span class="sd">                It is given in km, from the center.</span>
<span class="sd">            atcolor (str): Changes the color of atm lines.</span>
<span class="sd">            chord_delta (list): list with distances from center to plot chords</span>
<span class="sd">            chord_geo (2d-list): list with pairs of coordinates to plot chords</span>
<span class="sd">            chcolor (str): color of the line of the chords. Default: grey</span>
<span class="sd">            heights (list): It plots a circular dashed line showing the locations where the observer</span>
<span class="sd">                would observe the occultation at a given height above the horizons.</span>
<span class="sd">                This must be a list.</span>
<span class="sd">            hcolor (str): Changes the color of the height lines.</span>
<span class="sd">            mapsize (list): The size of figure, in cm. It must be a list with two values.</span>
<span class="sd">                Default = [46.0, 38.0].</span>
<span class="sd">            cpoints (int,float): Interval for the small points marking the center of shadow,</span>
<span class="sd">                in seconds. Default=60.</span>
<span class="sd">            ptcolor (str): Change the color of the center points.</span>
<span class="sd">            alpha (float): The transparency of the night shade, where 0.0 is full transparency</span>
<span class="sd">                and 1.0 is full black. Default = 0.2.</span>
<span class="sd">            fmt (str): The format to save the image. It is parsed directly by matplotlib.pyplot.</span>
<span class="sd">                Default = &#39;png&#39;</span>
<span class="sd">            dpi (int): &quot;Dots per inch&quot;. It defines the quality of the image. Default = 100.</span>
<span class="sd">            lncolor (str): Changes the color of the line that represents the limits of the shadow over Earth.</span>
<span class="sd">            outcolor (str): Changes the color of the lines that represents the limits of the shadow outside Earth</span>
<span class="sd">            nscale (int,float): Arbitrary scale for the size of the name of the site.</span>
<span class="sd">            cscale (int,float): Arbitrary scale for the name of the country.</span>
<span class="sd">            sscale (int,float): Arbitrary scale for the size of point of the site.</span>
<span class="sd">            pscale (int,float): Arbitrary scale for the size of the points that represent the center of the shadow</span>
<span class="sd">            arrow (bool): If true, it plots the arrow with the occultation direction.</span>

<span class="sd">            Comment: Only one of centermap_geo and centermap_delta can be given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot_occ_map</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PredictionTable.remove_occ"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable.remove_occ">[docs]</a>    <span class="k">def</span> <span class="nf">remove_occ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes stellar occultations from table</span>

<span class="sd">        Parameters:</span>
<span class="sd">            date (str,list): Date or list of dates of the occultation to be removed.</span>
<span class="sd">                The dates mut be as shown in the &#39;Epoch&#39; column. If the date is not</span>
<span class="sd">                complete, the function will select all occultations that matches the given string.</span>
<span class="sd">                For instance, date=&#39;2020-06&#39; will remove all occultations from the month of June 2020.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span><span class="p">]</span>
        <span class="n">itens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">date</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__itens_by_epoch</span><span class="p">(</span><span class="n">d</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">itens</span><span class="p">)</span></div>

<div class="viewcode-block" id="PredictionTable.keep_from_selected_images"><a class="viewcode-back" href="../../sora.html#sora.prediction.PredictionTable.keep_from_selected_images">[docs]</a>    <span class="k">def</span> <span class="nf">keep_from_selected_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Keeps predictions which images were not deleted in given path</span>
<span class="sd">            This function uses the name of the images to identify predictions.</span>
<span class="sd">            The name must be the automatic one generated by plot_occ_map().</span>
<span class="sd">            The format of the image is not relevant.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            path (str): path where images are located</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">itens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tca</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">tca</span><span class="o">.</span><span class="n">isot</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">itens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">itens</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="occ_params"><a class="viewcode-back" href="../../sora.html#sora.prediction.occ_params">[docs]</a><span class="k">def</span> <span class="nf">occ_params</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">ephem</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">n_recursions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the parameters of the occultation, as instant, CA, PA.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        star (Star): The coordinate of the star in the same reference frame as the ephemeris.</span>
<span class="sd">            It must be a Star object.</span>
<span class="sd">        ephem (Ephem): object ephemeris. It must be an Ephemeris object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        instant of CA (Time): Instant of Closest Approach</span>
<span class="sd">        CA (arcsec): Distance of Closest Approach</span>
<span class="sd">        PA (deg): Position Angle at Closest Approach</span>
<span class="sd">        vel (km/s): Velocity of the occultation</span>
<span class="sd">        dist (AU): the object geocentric distance.</span>
<span class="sd">        n_recursions (int): The number of attempts to try obtain prediction parameters</span>
<span class="sd">            in case the event is outside the previous range of time. Default=5</span>
<span class="sd">        max_tdiff (int): Maximum difference from given time it will attempt to identify</span>
<span class="sd">            the occultation, in minutes. If given, &#39;n_recursions&#39; is ignored. Default=None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n_recursions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_recursions</span><span class="p">)</span>
    <span class="n">n_iter</span> <span class="o">=</span> <span class="n">n_recursions</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Star</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;star must be a Star object&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ephem</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">EphemKernel</span><span class="p">,</span> <span class="n">EphemJPL</span><span class="p">,</span> <span class="n">EphemPlanete</span><span class="p">,</span> <span class="n">EphemHorizons</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ephem must be an Ephemeris object&#39;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">geocentric</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ephem</span><span class="p">)</span> <span class="o">==</span> <span class="n">EphemPlanete</span><span class="p">:</span>
        <span class="n">ephem</span><span class="o">.</span><span class="n">fit_d2_ksi_eta</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calc_min</span><span class="p">(</span><span class="n">time0</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">n_recursions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_tdiff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_t</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">max_tdiff</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">((</span><span class="n">time0</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">sec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_t</span> <span class="o">-</span> <span class="n">time_interval</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Occultation is farther than </span><span class="si">{}</span><span class="s1"> from given time&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_t</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Occultation is farther than </span><span class="si">{}</span><span class="s1"> min from given time&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_iter</span><span class="o">*</span><span class="n">time_interval</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">time0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">time_interval</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="n">ksi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ksi</span><span class="o">*</span><span class="n">ksi</span><span class="o">+</span><span class="n">eta</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">min</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calc_min</span><span class="p">(</span><span class="n">time0</span><span class="o">=</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span> <span class="n">delta_t</span><span class="o">=</span><span class="n">delta_t</span><span class="p">,</span>
                            <span class="n">n_recursions</span><span class="o">=</span><span class="n">n_recursions</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="n">max_tdiff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">min</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calc_min</span><span class="p">(</span><span class="n">time0</span><span class="o">=</span><span class="n">tt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span> <span class="n">delta_t</span><span class="o">=</span><span class="n">delta_t</span><span class="p">,</span>
                            <span class="n">n_recursions</span><span class="o">=</span><span class="n">n_recursions</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="n">max_tdiff</span><span class="p">)</span>

        <span class="n">ksi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="nb">min</span><span class="p">],</span> <span class="n">coord</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ksi</span><span class="o">*</span><span class="n">ksi</span><span class="o">+</span><span class="n">eta</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="nb">min</span><span class="p">])</span><span class="o">.</span><span class="n">distance</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">dd</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ksi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">+</span> <span class="mi">360</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>

        <span class="n">ksi2</span><span class="p">,</span> <span class="n">eta2</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_ksi_eta</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="nb">min</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
        <span class="n">dksi</span> <span class="o">=</span> <span class="n">ksi2</span><span class="o">-</span><span class="n">ksi</span>
        <span class="n">deta</span> <span class="o">=</span> <span class="n">eta2</span><span class="o">-</span><span class="n">eta</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dksi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">deta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">dksi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tt</span><span class="p">[</span><span class="nb">min</span><span class="p">],</span> <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ephem</span><span class="p">,</span> <span class="p">(</span><span class="n">EphemJPL</span><span class="p">,</span> <span class="n">EphemHorizons</span><span class="p">)):</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">calc_min</span><span class="p">(</span><span class="n">time0</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">delta_t</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_recursions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="n">max_tdiff</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">calc_min</span><span class="p">(</span><span class="n">time0</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">delta_t</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">n_recursions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="n">max_tdiff</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">calc_min</span><span class="p">(</span><span class="n">time0</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">delta_t</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">n_recursions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_tdiff</span><span class="o">=</span><span class="n">max_tdiff</span><span class="p">)</span></div>


<div class="viewcode-block" id="prediction"><a class="viewcode-back" href="../../sora.html#sora.prediction.prediction">[docs]</a><span class="k">def</span> <span class="nf">prediction</span><span class="p">(</span><span class="n">time_beg</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ephem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mag_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">divs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Predicts stellar occultations</span>

<span class="sd">    Parameters:</span>
<span class="sd">        time_beg (str,Time): Initial time for prediction (required).</span>
<span class="sd">        time_beg (str,Time): Final time for prediction (required).</span>
<span class="sd">        body* (Body, str): Object that will occult the stars. It must be a Body object or its</span>
<span class="sd">                name to search in the Small Body Database.</span>
<span class="sd">        ephem* (Ephem): object ephemeris. It must be an Ephemeris object.</span>
<span class="sd">        mag_lim (int,float): Faintest Gmag for search</span>
<span class="sd">        step (number): step, in seconds, of ephem times for search</span>
<span class="sd">        divs (int): number of regions the ephemeris will be splitted for better search of occultations</span>
<span class="sd">        sigma (number): ephemeris error sigma for search off-Earth.</span>
<span class="sd">        radius (number): The radius of the body. It is important if not defined in body or ephem.</span>
<span class="sd">        log (bool): To show what is being done at the moment.</span>

<span class="sd">    * When instantiating with &quot;body&quot; and &quot;ephem&quot;, the user may call the function in 3 ways:</span>
<span class="sd">        - With &quot;body&quot; and &quot;ephem&quot;.</span>
<span class="sd">        - With only &quot;body&quot;. In this case, the &quot;body&quot; parameter must be a Body object and have an</span>
<span class="sd">            ephemeris associated (see Body documentation).</span>
<span class="sd">        - With only &quot;ephem&quot;. In this case, the &quot;ephem&quot; parameter must be one of the Ephem Classes</span>
<span class="sd">            and have a name (see Ephem documentation) to search for the body in the Small Body Database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        predict (PredictionTable): PredictionTable with the occultation params for each event</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># generate ephemeris</span>
    <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ephem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;body&quot; and/or &quot;ephem&quot; must be given.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Body</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;body&quot; must be a string with the name of the object or a Body object&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">Body</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sbdb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ephem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">ephem</span> <span class="o">=</span> <span class="n">ephem</span>
            <span class="n">ephem</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">ephem</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ephem</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">ephem</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ephem</span><span class="p">,</span> <span class="n">EphemKernel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;At the moment prediction only works with EphemKernel&#39;</span><span class="p">)</span>
    <span class="n">time_beg</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time_beg</span><span class="p">)</span>
    <span class="n">time_end</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time_end</span><span class="p">)</span>
    <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">time_end</span><span class="o">-</span><span class="n">time_beg</span><span class="p">)</span><span class="o">.</span><span class="n">sec</span><span class="p">,</span> <span class="n">divs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># define catalogue parameters</span>
    <span class="n">kwds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;RA_ICRS&#39;</span><span class="p">,</span> <span class="s1">&#39;DE_ICRS&#39;</span><span class="p">,</span> <span class="s1">&#39;pmRA&#39;</span><span class="p">,</span> <span class="s1">&#39;pmDE&#39;</span><span class="p">,</span> <span class="s1">&#39;Plx&#39;</span><span class="p">,</span> <span class="s1">&#39;RV&#39;</span><span class="p">,</span> <span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;Gmag&#39;</span><span class="p">]</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;row_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10000000</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="k">if</span> <span class="n">mag_lim</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;column_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Gmag&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mag_lim</span><span class="p">)}</span>
    <span class="n">vquery</span> <span class="o">=</span> <span class="n">Vizier</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="c1"># determine suitable divisions for star search</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">radius</span>  <span class="c1"># for v1.0, change to body.radius</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;&quot;radius&quot; not given or found in body or ephem. Considering it to be zero.&#39;</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>

    <span class="n">radius_search</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">const</span><span class="o">.</span><span class="n">R_earth</span>

    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ephemeris was split in </span><span class="si">{}</span><span class="s1"> parts for better search of stars&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">divs</span><span class="p">))</span>

    <span class="c1"># makes predictions for each division</span>
    <span class="n">occs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">divs</span><span class="p">):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">time_beg</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Searching occultations in part </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">divs</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating Ephemeris between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">nt</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">ncoord</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">ncoord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">ncoord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">deg</span><span class="p">])</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">ncoord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">ncoord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">deg</span><span class="p">])</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">radius_search</span><span class="o">/</span><span class="n">ncoord</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span>
                   <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ephem</span><span class="o">.</span><span class="n">error_ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ephem</span><span class="o">.</span><span class="n">error_dec</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">ncoord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ncoord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mindist</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">ncoord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ncoord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mindist</span>
        <span class="n">pos_search</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading stars ...&#39;</span><span class="p">)</span>
        <span class="n">catalogue</span> <span class="o">=</span> <span class="n">vquery</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span><span class="n">pos_search</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="s1">&#39;I/345/gaia2&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalogue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    No star found. The region is too small or VizieR is out.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">catalogue</span> <span class="o">=</span> <span class="n">catalogue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{}</span><span class="s1"> Gaia-DR2 stars downloaded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catalogue</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Identifying occultations ...&#39;</span><span class="p">)</span>
        <span class="n">pm_ra_cosdec</span> <span class="o">=</span> <span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;pmRA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
        <span class="n">pm_ra_cosdec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pm_ra_cosdec</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">year</span>
        <span class="n">pm_dec</span> <span class="o">=</span> <span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;pmDE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
        <span class="n">pm_dec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pm_dec</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">year</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;RA_ICRS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;DE_ICRS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catalogue</span><span class="p">))</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span>
                         <span class="n">pm_ra_cosdec</span><span class="o">=</span><span class="n">pm_ra_cosdec</span><span class="p">,</span> <span class="n">pm_dec</span><span class="o">=</span><span class="n">pm_dec</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jyear&#39;</span><span class="p">))</span>
        <span class="n">prec_stars</span> <span class="o">=</span> <span class="n">stars</span><span class="o">.</span><span class="n">apply_space_motion</span><span class="p">(</span><span class="n">new_obstime</span><span class="o">=</span><span class="p">((</span><span class="n">nt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">nt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">nt</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">d3d</span> <span class="o">=</span> <span class="n">prec_stars</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">ncoord</span><span class="p">)</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">radius_search</span><span class="o">/</span><span class="n">ncoord</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ephem</span><span class="o">.</span><span class="n">error_ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ephem</span><span class="o">.</span><span class="n">error_dec</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> \
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">pm_ra_cosdec</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">stars</span><span class="o">.</span><span class="n">pm_dec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">nt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d2d</span> <span class="o">&lt;</span> <span class="n">dist</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">star</span> <span class="o">=</span> <span class="n">Star</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">],</span> <span class="n">ra</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;RA_ICRS&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;DE_ICRS&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                        <span class="n">pmra</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;pmRA&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">pmdec</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;pmDE&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                        <span class="n">parallax</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;Plx&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">,</span> <span class="n">rad_vel</span><span class="o">=</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;RV&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                        <span class="n">epoch</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jyear&#39;</span><span class="p">),</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nomad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">geocentric</span><span class="p">(</span><span class="n">nt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">ev</span><span class="p">])</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">dec</span><span class="p">),</span> <span class="n">catalogue</span><span class="p">[</span><span class="s1">&#39;Gmag&#39;</span><span class="p">][</span><span class="n">ev</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pars</span><span class="p">,</span> <span class="n">occ_params</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">ephem</span><span class="p">,</span> <span class="n">nt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">ev</span><span class="p">])))</span>
                <span class="n">occs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">ephem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;time_beg&#39;</span><span class="p">:</span> <span class="n">time_beg</span><span class="p">,</span> <span class="s1">&#39;time_end&#39;</span><span class="p">:</span> <span class="n">time_end</span><span class="p">,</span> <span class="s1">&#39;maglim&#39;</span><span class="p">:</span> <span class="n">mag_lim</span><span class="p">,</span> <span class="s1">&#39;max_ca&#39;</span><span class="p">:</span> <span class="n">mindist</span><span class="p">,</span>
            <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;error_ra&#39;</span><span class="p">:</span> <span class="n">ephem</span><span class="o">.</span><span class="n">error_ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;error_dec&#39;</span><span class="p">:</span> <span class="n">ephem</span><span class="o">.</span><span class="n">error_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;ephem&#39;</span><span class="p">:</span> <span class="n">ephem</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;kernels&#39;</span><span class="p">]}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">occs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No stellar occultation was found.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PredictionTable</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
    <span class="c1"># create astropy table with the params</span>
    <span class="n">occs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">occs</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">occs2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">geocentric</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">([</span><span class="n">ephem</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">time</span><span class="p">)])</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">PredictionTable</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">coord_star</span><span class="o">=</span><span class="n">occs2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">coord_obj</span><span class="o">=</span><span class="n">geocentric</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ca</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">occs2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">k</span><span class="p">]],</span>
        <span class="n">pa</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">occs2</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">k</span><span class="p">]],</span> <span class="n">vel</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">occs2</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">k</span><span class="p">]],</span> <span class="n">mag</span><span class="o">=</span><span class="n">occs2</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">k</span><span class="p">],</span>
        <span class="n">dist</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">occs2</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">k</span><span class="p">]],</span> <span class="n">source</span><span class="o">=</span><span class="n">occs2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> occultations found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="xy2latlon"><a class="viewcode-back" href="../../sora.html#sora.prediction.xy2latlon">[docs]</a><span class="k">def</span> <span class="nf">xy2latlon</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">loncen</span><span class="p">,</span> <span class="n">latcen</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the longitude and latitude given projected positions x and y</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x (int, float): Projected position in x, in the GCRS (meters)</span>
<span class="sd">        y (int, float): Projected position in y, in the GCRS (meters)</span>
<span class="sd">        loncen (int, float): Center longitude of projection (deg)</span>
<span class="sd">        latcen (int, float): Center latitude of projection (deg)</span>
<span class="sd">        time (Time): Time of refered projection</span>

<span class="sd">    Returns:</span>
<span class="sd">        lon, lat (float): Longitude and Latitude whose projection at loncen, lat results in x, y. (deg)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">R_earth</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">site_cen</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">loncen</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">latcen</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">itrs_cen</span> <span class="o">=</span> <span class="n">site_cen</span><span class="o">.</span><span class="n">get_itrs</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
    <span class="n">gcrs_cen</span> <span class="o">=</span> <span class="n">itrs_cen</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">GCRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">))</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="n">z</span><span class="o">*</span><span class="n">z</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x2</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1e+31</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1e+31</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span>
    <span class="n">center_frame</span> <span class="o">=</span> <span class="n">SkyOffsetFrame</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">gcrs_cen</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">time</span><span class="o">.</span><span class="n">isscalar</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">representation_type</span><span class="o">=</span><span class="s1">&#39;cartesian&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">center_frame</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="n">n_coord</span> <span class="o">=</span> <span class="n">new_pos</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">GCRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">))</span>
            <span class="n">n_itrs</span> <span class="o">=</span> <span class="n">n_coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ITRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">))</span>
            <span class="n">n_site</span> <span class="o">=</span> <span class="n">n_itrs</span><span class="o">.</span><span class="n">earth_location</span>
            <span class="n">n_site</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">n_site</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">n_site</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">itrs_site</span> <span class="o">=</span> <span class="n">n_site</span><span class="o">.</span><span class="n">get_itrs</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
            <span class="n">gcrs_site</span> <span class="o">=</span> <span class="n">itrs_site</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">GCRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">))</span>
            <span class="n">target1</span> <span class="o">=</span> <span class="n">gcrs_site</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">center_frame</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">lon</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_site</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">deg</span>
                <span class="n">lat</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_site</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">deg</span>
                <span class="k">break</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">target1</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span></div>


<div class="viewcode-block" id="latlon2xy"><a class="viewcode-back" href="../../sora.html#sora.prediction.latlon2xy">[docs]</a><span class="k">def</span> <span class="nf">latlon2xy</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">loncen</span><span class="p">,</span> <span class="n">latcen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the projection of longitude and latitude in the loncen, latcen direction.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        lon (int, float): Longitude to calculate projection</span>
<span class="sd">        lat (int, float): Latitude to calculate projection</span>
<span class="sd">        loncen (int, float): Center longitude of projection (deg)</span>
<span class="sd">        latcen (int, float): Center latitude of projection (deg)</span>

<span class="sd">    Returns:</span>
<span class="sd">        x, y (float): Projection of lon, lat at loncen, latcen, in the ITRS (meters)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">site_cen</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">loncen</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">latcen</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">itrs_cen</span> <span class="o">=</span> <span class="n">site_cen</span><span class="o">.</span><span class="n">get_itrs</span><span class="p">()</span>

    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">lon</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">lat</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="n">itrs_site</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">get_itrs</span><span class="p">()</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">itrs_site</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">SkyOffsetFrame</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">itrs_cen</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e+31</span>
    <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e+31</span>
    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>


<div class="viewcode-block" id="plot_occ_map"><a class="viewcode-back" href="../../sora.html#sora.prediction.plot_occ_map">[docs]</a><span class="k">def</span> <span class="nf">plot_occ_map</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">longi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plots map of the occultation</span>

<span class="sd">    Parameters:</span>
<span class="sd">        Required params:</span>
<span class="sd">        name (str): Name of the object</span>
<span class="sd">        radius (int, float): radius of the object (km)</span>
<span class="sd">        coord (str, SkyCoord): Coordinate of the star</span>
<span class="sd">            (&quot;hh mm ss.sss dd mm ss.sss&quot; or &quot;hh.hhhhhhhh dd.dddddddd&quot;)</span>
<span class="sd">        time (str, Time): Instant of Closest Approach (iso or isot format)</span>
<span class="sd">        ca (int, float): Closest Approach Distance (arcsec)</span>
<span class="sd">        pa (int, float): Position Angle at C/A (deg)</span>
<span class="sd">        vel (int, vel): Velocity of the event (km/s)</span>
<span class="sd">        dist (int, float): Object distance at C/A (AU)</span>

<span class="sd">        Not required params (only printed in label):</span>
<span class="sd">        mag (int,float): Mag* = Normalized magnitude to vel=20km/s</span>
<span class="sd">        longi (int,float): East longitude of sub-planet point, deg, positive towards East</span>

<span class="sd">        Map configuration:</span>
<span class="sd">        nameimg (str): Change the name of the imaged saved.</span>
<span class="sd">        path (str): Path to a directory where to save map.</span>
<span class="sd">        resolution (int): Cartopy feature resolution. &quot;1&quot; means a resolution of &quot;10m&quot;,</span>
<span class="sd">            &quot;2&quot; a resolution of &quot;50m&quot; and &quot;3&quot; a resolution of &quot;100m&quot;. Default = 2</span>
<span class="sd">        states (bool): True to plot the state division of the countries. The states of</span>
<span class="sd">            some countries will only be shown depending on the resolution.</span>
<span class="sd">        zoom (int, float): Zooms in or out of the map.</span>
<span class="sd">        centermap_geo (list): Center the map given coordinates in longitude and latitude.</span>
<span class="sd">            It must be a list with two numbers. Default=None.</span>
<span class="sd">        centermap_delta (list): Displace the center of the map given displacement</span>
<span class="sd">            in X and Y, in km. It must be a list with two numbers. Default=None.</span>
<span class="sd">        centerproj (list): Rotates the Earth to show occultation with the center</span>
<span class="sd">            projected at a given longitude and latitude. It must be a list with two numbers</span>
<span class="sd">        labels (bool): Plots text above and below the map with the occultation parameters.</span>
<span class="sd">            Default=True.</span>
<span class="sd">        meridians (int): Plots lines representing the meridians for given interval. Default=30 deg</span>
<span class="sd">        parallels (int): Plots lines representing the parallels for given interval. Default=30 deg</span>
<span class="sd">        sites (dict): Plots site positions in map. It must be a python dictionary where the key is</span>
<span class="sd">            the name of the site, and the value is a list with longitude, latitude, delta_x,</span>
<span class="sd">            delta_y and color. delta_x and delta_y are displacement, in km, from the point</span>
<span class="sd">            of the site in the map and the name. color is the color of the point.</span>
<span class="sd">        site_name (bool): If True, it prints the name of the sites given, else it plots only the points</span>
<span class="sd">        countries (dict): Plots the names of countries. It must be a python dictionary where the key</span>
<span class="sd">            is the name of the country and the value is a list with longitude and latitude</span>
<span class="sd">            of the lower left part of the text.</span>
<span class="sd">        offset (list): applies an offset to the ephemeris, calculating new CA and instant of CA.</span>
<span class="sd">            It is a pair of delta_RA*cosDEC and delta_DEC.</span>
<span class="sd">        mapstyle (int): Define the color style of the map. 1 is the default black and white scale.</span>
<span class="sd">            2 is a colored map.</span>
<span class="sd">        error (int,float): Ephemeris error in mas. It plots a dashed line representing radius + error.</span>
<span class="sd">        ercolor (str): Changes the color of the lines of the error bar.</span>
<span class="sd">        ring (int,float): plots a dashed line representing the location of a ring.</span>
<span class="sd">            It is given in km, from the center.</span>
<span class="sd">        rncolor (str): Changes the color of ring lines.</span>
<span class="sd">        atm (int,float): plots a dashed line representing the location of an atmosphere.</span>
<span class="sd">            It is given in km, from the center.</span>
<span class="sd">        atcolor (str): Changes the color of atm lines.</span>
<span class="sd">        chord_delta (list): list with distances from center to plot chords</span>
<span class="sd">        chord_geo (2d-list): list with pairs of coordinates to plot chords</span>
<span class="sd">        chcolor (str): color of the line of the chords. Default: grey</span>
<span class="sd">        heights (list): It plots a circular dashed line showing the locations where the observer</span>
<span class="sd">            would observe the occultation at a given height above the horizons.</span>
<span class="sd">            This must be a list.</span>
<span class="sd">        hcolor (str): Changes the color of the height lines.</span>
<span class="sd">        mapsize (list): The size of figure, in cm. It must be a list with two values.</span>
<span class="sd">            Default = [46.0, 38.0].</span>
<span class="sd">        cpoints (int,float): Interval for the small points marking the center of shadow,</span>
<span class="sd">            in seconds. Default=60.</span>
<span class="sd">        ptcolor (str): Change the color of the center points.</span>
<span class="sd">        alpha (float): The transparency of the night shade, where 0.0 is full transparency</span>
<span class="sd">            and 1.0 is full black. Default = 0.2.</span>
<span class="sd">        fmt (str): The format to save the image. It is parsed directly by matplotlib.pyplot.</span>
<span class="sd">            Default = &#39;png&#39;</span>
<span class="sd">        dpi (int): &quot;Dots per inch&quot;. It defines the quality of the image. Default = 100.</span>
<span class="sd">        lncolor (str): Changes the color of the line that represents the limits of the shadow over Earth.</span>
<span class="sd">        outcolor (str): Changes the color of the lines that represents the limits of the shadow outside Earth</span>
<span class="sd">        nscale (int,float): Arbitrary scale for the size of the name of the site.</span>
<span class="sd">        cscale (int,float): Arbitrary scale for the name of the country.</span>
<span class="sd">        sscale (int,float): Arbitrary scale for the size of point of the site.</span>
<span class="sd">        pscale (int,float): Arbitrary scale for the size of the points that represent the center of the shadow</span>
<span class="sd">        arrow (bool): If true, it plots the arrow with the occultation direction.</span>

<span class="sd">        Comment: Only one of centermap_geo and centermap_delta can be given</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
    <span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>

    <span class="n">allowed_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;arrow&#39;</span><span class="p">,</span> <span class="s1">&#39;atcolor&#39;</span><span class="p">,</span> <span class="s1">&#39;atm&#39;</span><span class="p">,</span> <span class="s1">&#39;centermap_delta&#39;</span><span class="p">,</span> <span class="s1">&#39;centermap_geo&#39;</span><span class="p">,</span> <span class="s1">&#39;centerproj&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;chcolor&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_delta&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_geo&#39;</span><span class="p">,</span> <span class="s1">&#39;countries&#39;</span><span class="p">,</span> <span class="s1">&#39;cpoints&#39;</span><span class="p">,</span> <span class="s1">&#39;cscale&#39;</span><span class="p">,</span> <span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="s1">&#39;ercolor&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;hcolor&#39;</span><span class="p">,</span> <span class="s1">&#39;heights&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="s1">&#39;lncolor&#39;</span><span class="p">,</span> <span class="s1">&#39;mapsize&#39;</span><span class="p">,</span> <span class="s1">&#39;mapstyle&#39;</span><span class="p">,</span> <span class="s1">&#39;meridians&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;nameimg&#39;</span><span class="p">,</span> <span class="s1">&#39;nscale&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;outcolor&#39;</span><span class="p">,</span> <span class="s1">&#39;parallels&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;pscale&#39;</span><span class="p">,</span> <span class="s1">&#39;ptcolor&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;ring&#39;</span><span class="p">,</span> <span class="s1">&#39;rncolor&#39;</span><span class="p">,</span> <span class="s1">&#39;site_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="s1">&#39;sscale&#39;</span><span class="p">,</span> <span class="s1">&#39;states&#39;</span><span class="p">,</span> <span class="s1">&#39;zoom&#39;</span><span class="p">]</span>
    <span class="n">input_tests</span><span class="o">.</span><span class="n">check_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">allowed_kwargs</span><span class="o">=</span><span class="n">allowed_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;name keyword must be a string&#39;</span><span class="p">)</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>

    <span class="n">occs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;&quot;star&quot; keyword is not in the format: &quot;hh mm ss.sss dd mm ss.sss&quot; or &quot;hh.hhhhhhhh dd.dddddddd&quot;&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;datas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;&quot;time&quot; keyword is not a iso or isot time format&#39;</span><span class="p">)</span>
    <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;ca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
    <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span>
    <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;magG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span>
    <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;longi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">longi</span>

    <span class="n">mapstyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mapstyle&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mapstyle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mapstyle must be 1 or 2]&#39;</span><span class="p">)</span>

    <span class="n">resolution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;resolution keyword must be one of these: [1, 2, 3] where 1=10m, 2=50m and 3=100m&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span> <span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="s1">&#39;110m&#39;</span><span class="p">]</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">resolution</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">nameimg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nameimg&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;datas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isot</span><span class="p">))</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">dpi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mapsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mapsize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">46.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span>
    <span class="n">erro</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ring</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ring&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">atm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">cpoints</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpoints&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;states&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">meridians</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meridians&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">parallels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parallels&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">nscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nscale&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cscale&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sscale&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pscale&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;heights&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">centermap_geo</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;centermap_geo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">centermap_delta</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;centermap_delta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;centermap_geo&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;centermap_delta&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;User must give &quot;centermap_geo&quot; OR &quot;centermap_delta&quot;&#39;</span><span class="p">)</span>
    <span class="n">zoom</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">off_ra</span><span class="p">,</span> <span class="n">off_de</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
    <span class="n">arrow</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arrow&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">site_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;site_name&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">chord_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chord_delta&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
    <span class="n">chord_geo</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chord_geo&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chord_geo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chord_geo</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">chord_geo</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;chord_geo must a set of pairs with longitude and latitude&#39;</span><span class="p">)</span>
        <span class="n">chord_geo</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="o">*</span><span class="n">chord_geo</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;sites&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;offx&#39;</span><span class="p">,</span> <span class="s1">&#39;offy&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">),</span>
                                                      <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">)},</span>
                              <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">sites</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;offx&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;offy&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;sites keyword must be a file or a dictionary&#39;</span><span class="p">)</span>

    <span class="n">countries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;countries&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;countries&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;countries&#39;</span><span class="p">]):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;countries&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">),</span> <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">)},</span>
                              <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">countries</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;countries&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">countries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;countries&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;country keyword must be a file or a dictionary&#39;</span><span class="p">)</span>

<span class="c1"># calculates offsets</span>
    <span class="n">dca</span> <span class="o">=</span> <span class="n">off_ra</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">off_de</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">])</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">off_ra</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">off_de</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">*</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="n">ca1</span> <span class="o">=</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;ca&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dca</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;datas&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span>

<span class="c1"># define map parameters</span>
    <span class="n">center_gcrs</span> <span class="o">=</span> <span class="n">GCRS</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">R_earth</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">center_itrs</span> <span class="o">=</span> <span class="n">center_gcrs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ITRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">data</span><span class="p">))</span>
    <span class="n">center_map</span> <span class="o">=</span> <span class="n">center_itrs</span><span class="o">.</span><span class="n">earth_location</span>
    <span class="n">centert</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;centerproj&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;centerproj&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">EarthLocation</span><span class="p">:</span>
            <span class="n">center_map</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;centerproj&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;centerproj&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
            <span class="n">center_map</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;centerproj&#39;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;centerproj must be an Astropy EarthLocation Object or an array with Longitude and Latitude only&#39;</span><span class="p">)</span>
        <span class="n">centert</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">mapsize</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">imperial</span><span class="o">.</span><span class="n">inch</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="n">center_map</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="n">center_map</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">axf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.002</span><span class="p">,</span> <span class="mf">1.002</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>

<span class="c1"># calculates regions for zoom</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">R_earth</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">centermap_geo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">latlon2xy</span><span class="p">(</span><span class="n">centermap_geo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centermap_geo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center_map</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">center_map</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">cx</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">cy</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Coordinates for centermap_geo are outside the visible range.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">centermap_delta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">centermap_delta</span>
    <span class="k">elif</span> <span class="n">zoom</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">zoom</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dmsize</span> <span class="o">=</span> <span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mapsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mapsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">-</span> <span class="n">dr</span><span class="o">*</span><span class="n">dmsize</span>
            <span class="n">ux</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">+</span> <span class="n">dr</span><span class="o">*</span><span class="n">dmsize</span>
            <span class="n">ly</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">-</span> <span class="n">dr</span>
            <span class="n">uy</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">+</span> <span class="n">dr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">-</span> <span class="n">dr</span>
            <span class="n">ux</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">+</span> <span class="n">dr</span>
            <span class="n">ly</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">-</span> <span class="n">dr</span><span class="o">/</span><span class="n">dmsize</span>
            <span class="n">uy</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">+</span> <span class="n">dr</span><span class="o">/</span><span class="n">dmsize</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lx</span><span class="p">,</span> <span class="n">ux</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ly</span><span class="p">,</span> <span class="n">uy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">and</span> <span class="n">zoom</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">centert</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># plots features</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.3&#39;</span><span class="p">)</span>
    <span class="n">ocean</span> <span class="o">=</span> <span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span><span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">land</span> <span class="o">=</span> <span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span><span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="s1">&#39;land&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">border</span> <span class="o">=</span> <span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_0_countries&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mapstyle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">ocean</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.9&#39;</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">land</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.4&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">RIVERS</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">)</span>
        <span class="n">ptcolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
        <span class="n">lncolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="n">ercolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="n">rncolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="n">atcolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="n">outcolor</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">hcolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
        <span class="n">chcolor</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
    <span class="k">elif</span> <span class="n">mapstyle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">ocean</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COLORS</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">])</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">land</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COLORS</span><span class="p">[</span><span class="s1">&#39;land&#39;</span><span class="p">])</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COLORS</span><span class="p">[</span><span class="s1">&#39;land&#39;</span><span class="p">])</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">RIVERS</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ptcolor</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">lncolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="n">ercolor</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">rncolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
        <span class="n">atcolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
        <span class="n">outcolor</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">hcolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
        <span class="n">chcolor</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
    <span class="k">if</span> <span class="n">states</span><span class="p">:</span>
        <span class="n">states_r</span> <span class="o">=</span> <span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_1_states_provinces&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">states_r</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.6&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

    <span class="n">gl</span> <span class="o">=</span> <span class="n">axf</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">xlocs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mf">180.001</span><span class="p">,</span> <span class="n">meridians</span><span class="p">),</span> <span class="n">ylocs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mf">90.001</span><span class="p">,</span> <span class="n">parallels</span><span class="p">))</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">n_steps</span> <span class="o">=</span> <span class="mi">180</span>
    <span class="n">sun</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sun_lat</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="n">dec</span>
    <span class="n">sun_lon</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;greenwich&#39;</span><span class="p">)</span>
    <span class="n">pole_lon</span> <span class="o">=</span> <span class="n">sun_lon</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">pole_lat</span> <span class="o">=</span> <span class="n">sun_lat</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">proj_sun</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="n">pole_lon</span><span class="o">+</span><span class="mi">180</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=-</span><span class="n">pole_lat</span><span class="p">)</span>
    <span class="n">bordx</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">361</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">bordy</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">361</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">bordx</span><span class="p">,</span> <span class="n">bordy</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_sun</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">bordx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">18</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">bordy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">18</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_sun</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">ptcolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ptcolor&#39;</span><span class="p">,</span> <span class="n">ptcolor</span><span class="p">)</span>
    <span class="n">lncolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lncolor&#39;</span><span class="p">,</span> <span class="n">lncolor</span><span class="p">)</span>
    <span class="n">ercolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ercolor&#39;</span><span class="p">,</span> <span class="n">ercolor</span><span class="p">)</span>
    <span class="n">rncolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rncolor&#39;</span><span class="p">,</span> <span class="n">rncolor</span><span class="p">)</span>
    <span class="n">atcolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atcolor&#39;</span><span class="p">,</span> <span class="n">atcolor</span><span class="p">)</span>
    <span class="n">outcolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outcolor&#39;</span><span class="p">,</span> <span class="n">outcolor</span><span class="p">)</span>
    <span class="n">hcolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hcolor&#39;</span><span class="p">,</span> <span class="n">hcolor</span><span class="p">)</span>
    <span class="n">chcolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chcolor&#39;</span><span class="p">,</span> <span class="n">chcolor</span><span class="p">)</span>

<span class="c1"># calculates path</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8000</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))),</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">vec</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">])</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">wrap_at</span><span class="p">(</span><span class="s1">&#39;180d&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pa</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">:</span>
        <span class="n">paplus</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">-</span> <span class="mi">180</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    <span class="k">elif</span> <span class="n">pa</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">:</span>
        <span class="n">paplus</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">+</span> <span class="mi">180</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">paplus</span> <span class="o">=</span> <span class="n">pa</span>
    <span class="n">deltatime</span> <span class="o">=</span> <span class="n">vec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="n">datas1</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">deltatime</span>
    <span class="n">centers_gcrs</span> <span class="o">=</span> <span class="n">GCRS</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datas1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datas1</span><span class="p">)),</span>
                        <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">R_earth</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">datas1</span><span class="p">)</span>
    <span class="n">centers_itrs</span> <span class="o">=</span> <span class="n">centers_gcrs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ITRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">datas1</span><span class="p">))</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">centers_itrs</span><span class="o">.</span><span class="n">earth_location</span>

    <span class="n">dista</span> <span class="o">=</span> <span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">ca1</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">dista</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltatime</span><span class="o">*</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">by</span> <span class="o">=</span> <span class="n">dista</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">deltatime</span><span class="o">*</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">-</span> <span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">by2</span> <span class="o">=</span> <span class="n">by</span> <span class="o">-</span> <span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">lncolor</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&gt;</span> <span class="mf">1e+30</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;centerproj&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">outcolor</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">centert</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">by3</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon2</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">lncolor</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon2</span> <span class="o">&gt;</span> <span class="mf">1e+30</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;centerproj&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">outcolor</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">centert</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># plots chords_delta</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">chord_delta</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by2</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">chcolor</span><span class="p">)</span>

<span class="c1"># plots chords_geo</span>
    <span class="k">for</span> <span class="n">coord_geo</span> <span class="ow">in</span> <span class="n">chord_geo</span><span class="p">:</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">latlon2xy</span><span class="p">(</span><span class="n">coord_geo</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">coord_geo</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xt</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">by</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">yt</span><span class="o">-</span><span class="n">by</span><span class="p">)[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="n">xt</span><span class="o">-</span><span class="n">ax</span><span class="p">)[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span><span class="o">*</span><span class="n">val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by2</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">chcolor</span><span class="p">)</span>

<span class="c1"># plots error</span>
    <span class="k">if</span> <span class="n">erro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">erro</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span>
        <span class="n">errd</span> <span class="o">=</span> <span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">err</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">-</span> <span class="n">errd</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span> <span class="o">-</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by2</span> <span class="o">=</span> <span class="n">by</span> <span class="o">-</span> <span class="n">errd</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span> <span class="o">-</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">ercolor</span><span class="p">)</span>

        <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">errd</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span> <span class="o">+</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by3</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="n">errd</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span> <span class="o">+</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon2</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">ercolor</span><span class="p">)</span>

<span class="c1"># plots ring</span>
    <span class="k">if</span> <span class="n">ring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">ring</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">-</span> <span class="n">rng</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by2</span> <span class="o">=</span> <span class="n">by</span> <span class="o">-</span> <span class="n">rng</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">rncolor</span><span class="p">)</span>

        <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">rng</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by3</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="n">rng</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon2</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">rncolor</span><span class="p">)</span>

<span class="c1"># plots atm</span>
    <span class="k">if</span> <span class="n">atm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atmo</span> <span class="o">=</span> <span class="n">atm</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">-</span> <span class="n">atmo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by2</span> <span class="o">=</span> <span class="n">by</span> <span class="o">-</span> <span class="n">atmo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">atcolor</span><span class="p">)</span>

        <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">atmo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">by3</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="n">atmo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
        <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">ax3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">by3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lon2</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lon2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lat2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>  <span class="n">color</span><span class="o">=</span><span class="n">atcolor</span><span class="p">)</span>

<span class="c1"># plots center points</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8000</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))),</span> <span class="n">cpoints</span><span class="p">)</span>
    <span class="n">deltatime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">vec</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="n">axc</span> <span class="o">=</span> <span class="n">dista</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltatime</span><span class="o">*</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">byc</span> <span class="o">=</span> <span class="n">dista</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">deltatime</span><span class="o">*</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">byc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ptcolor</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">centert</span><span class="p">),</span>
             <span class="n">markersize</span><span class="o">=</span><span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">pscale</span><span class="o">*</span><span class="mf">8.0</span><span class="o">/</span><span class="mf">46.0</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="n">datas2</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">deltatime</span>
    <span class="n">centers_p_gcrs</span> <span class="o">=</span> <span class="n">GCRS</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datas2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datas2</span><span class="p">)),</span>
                          <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">R_earth</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">datas2</span><span class="p">)</span>
    <span class="n">centers_p_itrs</span> <span class="o">=</span> <span class="n">centers_p_gcrs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ITRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">datas2</span><span class="p">))</span>
    <span class="n">centers_p</span> <span class="o">=</span> <span class="n">centers_p_itrs</span><span class="o">.</span><span class="n">earth_location</span>
    <span class="n">clon1</span><span class="p">,</span> <span class="n">clat1</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">axc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">byc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers_p</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">centers_p</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">datas2</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clon1</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
    <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clon1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">clat1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">ptcolor</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">markersize</span><span class="o">=</span><span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">pscale</span><span class="o">*</span><span class="mf">8.0</span><span class="o">/</span><span class="mf">46.0</span><span class="p">)</span>

    <span class="n">datas1</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">deltatime</span>
    <span class="n">center_gcrs</span> <span class="o">=</span> <span class="n">GCRS</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                       <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">R_earth</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">center_itrs</span> <span class="o">=</span> <span class="n">center_gcrs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ITRS</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">data</span><span class="p">))</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">center_itrs</span><span class="o">.</span><span class="n">earth_location</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dista</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="n">yp</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dista</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="n">loncen</span><span class="p">,</span> <span class="n">latcen</span> <span class="o">=</span> <span class="n">xy2latlon</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">loncen</span> <span class="o">&lt;</span> <span class="mf">1e+30</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loncen</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">latcen</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">ptcolor</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">markersize</span><span class="o">=</span><span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">pscale</span><span class="o">*</span><span class="mf">24.0</span><span class="o">/</span><span class="mf">46.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">centert</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ptcolor</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">pscale</span><span class="o">*</span><span class="mf">24.0</span><span class="o">/</span><span class="mf">46.0</span><span class="p">)</span>

<span class="c1"># plots the heights</span>
    <span class="k">if</span> <span class="s1">&#39;heights&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">heights</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bordx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">bordy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">hcolor</span><span class="p">)</span>

<span class="c1"># plots the the direction arrow</span>
    <span class="k">if</span> <span class="n">arrow</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="mi">5500000</span><span class="p">,</span> <span class="o">-</span><span class="mi">5500000</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="o">+</span><span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="o">+</span><span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">lx</span> <span class="o">+</span> <span class="p">(</span><span class="n">ux</span><span class="o">-</span><span class="n">lx</span><span class="p">)</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">ly</span> <span class="o">+</span> <span class="p">(</span><span class="n">uy</span><span class="o">-</span><span class="n">ly</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">paplus</span><span class="o">+</span><span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">paplus</span><span class="o">+</span><span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>

<span class="c1"># plots the countries names</span>
    <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">countries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">countries</span><span class="p">[</span><span class="n">country</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">countries</span><span class="p">[</span><span class="n">country</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">country</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>
                 <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">cscale</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">)</span>

<span class="c1"># plots the sites</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span>
                 <span class="n">markersize</span><span class="o">=</span><span class="n">mapsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">sscale</span><span class="o">*</span><span class="mf">10.0</span><span class="o">/</span><span class="mf">46.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">site_name</span><span class="p">:</span>
            <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">latlon2xy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">center_map</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">center_map</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">axf</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xt</span> <span class="o">+</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">yt</span><span class="o">+</span><span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="n">nscale</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">)</span>

<span class="c1"># Define the title and label of the output</span>
    <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Object        Diam   Tmax   dots &lt;&gt; ra_offset_dec</span><span class="se">\n</span><span class="s1">&#39;</span>
             <span class="s1">&#39;</span><span class="si">{:10s}</span><span class="s1"> </span><span class="si">{:4.0f}</span><span class="s1"> km  </span><span class="si">{:5.1f}</span><span class="s1">s  </span><span class="si">{:02d}</span><span class="s1"> s &lt;&gt;</span><span class="si">{:+6.1f}</span><span class="s1"> </span><span class="si">{:+6.1f}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>
             <span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">cpoints</span><span class="p">,</span> <span class="n">off_ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">off_de</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="n">labelx</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> year-m-d    h:m:s UT     ra__dec__J2000__candidate    C/A    P/A    vel   Delta   G*  long</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">  </span><span class="si">{:02d}</span><span class="s2"> </span><span class="si">{:02d}</span><span class="s2"> </span><span class="si">{:07.4f}</span><span class="s2"> </span><span class="si">{:+03d}</span><span class="s2"> </span><span class="si">{:02d}</span><span class="s2"> </span><span class="si">{:06.3f}</span><span class="s2"> </span><span class="si">{:6.3f}</span><span class="s2"> </span><span class="si">{:6.2f}</span><span class="s2"> </span><span class="si">{:6.2f}</span><span class="s2">  </span><span class="si">{:5.2f}</span><span class="s2"> </span><span class="si">{:5.1f}</span><span class="s2">  </span><span class="si">{:3.0f}</span><span class="s2">&quot;</span><span class="o">.</span>
              <span class="nb">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iso</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">h</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">m</span><span class="p">),</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                     <span class="nb">int</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">m</span><span class="p">)),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">occs</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">s</span><span class="p">),</span> <span class="n">ca1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;posa&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;magG&#39;</span><span class="p">],</span> <span class="n">occs</span><span class="p">[</span><span class="s1">&#39;longi&#39;</span><span class="p">]))</span>

<span class="c1"># plots the map</span>
    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">axf</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">labelx</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span>
                 <span class="n">transform</span><span class="o">=</span><span class="n">axf</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nameimg</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1"> generated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nameimg</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, SORA Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>